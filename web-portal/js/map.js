Ext.onReady(function(){Ext.define("Ext.ux.button.ColorButton",{extend:"Ext.button.Button",alias:"widget.colorbutton",width:109,height:22,defaultValue:null,value:"f1f1f1",getValue:function(){return this.value},setValue:function(a){this.value=a;if(Ext.isDefined(this.getEl())){this.getEl().dom.style.background="#"+a}},reset:function(){this.setValue(this.defaultValue)},menu:{},menuHandler:function(){},initComponent:function(){var a=this;this.defaultValue=this.value;this.menu=Ext.create("Ext.menu.Menu",{showSeparator:false,items:{xtype:"colorpicker",closeAction:"hide",listeners:{select:function(c,b){a.setValue(b);a.menu.hide();a.menuHandler(c,b)}}}});this.callParent()},listeners:{render:function(){this.setValue(this.value)}}});Ext.define("Ext.ux.layout.component.form.MultiSelect",{extend:"Ext.layout.component.field.Field",alias:["layout.multiselectfield"],type:"multiselectfield",defaultHeight:200,sizeBodyContents:function(e,d){var f=this;if(!Ext.isNumber(d)){d=f.defaultHeight}f.owner.panel.setSize(e,d)}});Ext.define("Ext.ux.form.MultiSelect",{extend:"Ext.form.field.Base",alternateClassName:"Ext.ux.Multiselect",alias:["widget.multiselect","widget.multiselectfield"],uses:["Ext.view.BoundList","Ext.form.FieldSet","Ext.ux.layout.component.form.MultiSelect","Ext.view.DragZone","Ext.view.DropZone"],ddReorder:false,appendOnly:false,displayField:"text",allowBlank:true,minSelections:0,maxSelections:Number.MAX_VALUE,blankText:"This field is required",minSelectionsText:"Minimum {0} item(s) required",maxSelectionsText:"Maximum {0} item(s) allowed",delimiter:",",componentLayout:"multiselectfield",fieldBodyCls:Ext.baseCSSPrefix+"form-multiselect-body",initComponent:function(){var a=this;a.bindStore(a.store,true);if(a.store.autoCreated){a.valueField=a.displayField="field1";if(!a.store.expanded){a.displayField="field2"}}if(!Ext.isDefined(a.valueField)){a.valueField=a.displayField}a.callParent()},bindStore:function(a,c){var d=this,e=d.store,b=d.boundList;if(e&&!c&&e!==a&&e.autoDestroy){e.destroy()}d.store=a?Ext.data.StoreManager.lookup(a):null;if(b){b.bindStore(a||null)}},onRender:function(e,a){var f=this,b,d,c;f.callParent(arguments);d=f.boundList=Ext.create("Ext.view.BoundList",{multiSelect:true,store:f.store,displayField:f.displayField,border:false});c=d.getSelectionModel();f.mon(c,{selectionChange:f.onSelectionChange,scope:f});b=f.panel=Ext.create("Ext.panel.Panel",{title:f.listTitle,tbar:f.tbar,items:[d],renderTo:f.bodyEl,layout:"fit"});b.ownerCt=f;f.setRawValue(f.rawValue)},getSubTplMarkup:function(){return""},afterRender:function(){var a=this;a.callParent();if(a.ddReorder&&!a.dragGroup&&!a.dropGroup){a.dragGroup=a.dropGroup="MultiselectDD-"+Ext.id()}if(a.draggable||a.dragGroup){a.dragZone=Ext.create("Ext.view.DragZone",{view:a.boundList,ddGroup:a.dragGroup,dragText:"{0} Item{1}"})}if(a.droppable||a.dropGroup){a.dropZone=Ext.create("Ext.view.DropZone",{view:a.boundList,ddGroup:a.dropGroup,handleNodeDrop:function(h,g,b){var c=this.view,e=c.getStore(),d=h.records,f;h.view.store.remove(d);f=e.indexOf(g);if(b==="after"){f++}e.insert(f,d);c.getSelectionModel().select(d)}})}},onSelectionChange:function(){this.checkChange()},clearValue:function(){this.setValue([])},getSubmitValue:function(){var b=this,a=b.delimiter,c=b.getValue();return Ext.isString(a)?c.join(a):c},getRawValue:function(){var b=this,a=b.boundList;if(a){b.rawValue=Ext.Array.map(a.getSelectionModel().getSelection(),function(c){return c.get(b.valueField)})}return b.rawValue},setRawValue:function(c){var b=this,a=b.boundList,d;c=Ext.Array.from(c);b.rawValue=c;if(a){d=[];Ext.Array.forEach(c,function(g){var f,e=b.store.findRecord(b.valueField,g,f,f,true,true);if(e){d.push(e)}});a.getSelectionModel().select(d,false,true)}return c},valueToRaw:function(a){return a},isEqual:function(e,d){var b=Ext.Array.from,c,a;e=b(e);d=b(d);a=e.length;if(a!==d.length){return false}for(c=0;c<a;c++){if(d[c]!==e[c]){return false}}return true},getErrors:function(b){var a=this,c=Ext.String.format,e=a.callParent(arguments),d;b=Ext.Array.from(b||a.getValue());d=b.length;if(!a.allowBlank&&d<1){e.push(a.blankText)}if(d<this.minSelections){e.push(c(a.minSelectionsText,a.minSelections))}if(d>this.maxSelections){e.push(c(a.maxSelectionsText,a.maxSelections))}return e},onDisable:function(){this.callParent();this.disabled=true;this.updateReadOnly()},onEnable:function(){this.callParent();this.disabled=false;this.updateReadOnly()},setReadOnly:function(a){this.readOnly=a;this.updateReadOnly()},updateReadOnly:function(){var b=this,a=b.boundList,c=b.readOnly||b.disabled;if(a){a.getSelectionModel().setLocked(c)}},onDestroy:function(){Ext.destroyMembers(this,"panel","boundList","dragZone","dropZone");this.callParent()}});OpenLayers.Util.OSM={};OpenLayers.Util.OSM.MISSING_TILE_URL="http://www.openstreetmap.org/openlayers/img/404.png";OpenLayers.Util.OSM.originalOnImageLoadError=OpenLayers.Util.onImageLoadError;OpenLayers.Util.onImageLoadError=function(){if(this.src.match(/^http:\/\/[abc]\.[a-z]+\.openstreetmap\.org\//)){this.src=OpenLayers.Util.OSM.MISSING_TILE_URL}else{if(this.src.match(/^http:\/\/[def]\.tah\.openstreetmap\.org\//)){}else{OpenLayers.Util.OSM.originalOnImageLoadError}}};OpenLayers.Layer.OSM.Mapnik=OpenLayers.Class(OpenLayers.Layer.OSM,{initialize:function(g,h){var e=["http://a.tile.openstreetmap.org/${z}/${x}/${y}.png","http://b.tile.openstreetmap.org/${z}/${x}/${y}.png","http://c.tile.openstreetmap.org/${z}/${x}/${y}.png"];h=OpenLayers.Util.extend({numZoomLevels:19,buffer:0,transitionEffect:"resize"},h);var f=[g,e,h];OpenLayers.Layer.OSM.prototype.initialize.apply(this,f)},CLASS_NAME:"OpenLayers.Layer.OSM.Mapnik"});OpenLayers.Layer.OSM.Osmarender=OpenLayers.Class(OpenLayers.Layer.OSM,{initialize:function(g,h){var e=["http://a.tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png","http://b.tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png","http://c.tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png"];h=OpenLayers.Util.extend({numZoomLevels:18,buffer:0,transitionEffect:"resize"},h);var f=[g,e,h];OpenLayers.Layer.OSM.prototype.initialize.apply(this,f)},CLASS_NAME:"OpenLayers.Layer.OSM.Osmarender"});OpenLayers.Layer.OSM.CycleMap=OpenLayers.Class(OpenLayers.Layer.OSM,{initialize:function(g,h){var e=["http://a.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png","http://b.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png","http://c.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png"];h=OpenLayers.Util.extend({numZoomLevels:19,buffer:0,transitionEffect:"resize"},h);var f=[g,e,h];OpenLayers.Layer.OSM.prototype.initialize.apply(this,f)},CLASS_NAME:"OpenLayers.Layer.OSM.CycleMap"});OpenLayers.Control.Circle=OpenLayers.Class(OpenLayers.Control,{feature:null,layer:null,radius:5,origin:null,sides:40,angle:null,snapAngle:null,dragControl:null,initialize:function(b){OpenLayers.Control.prototype.initialize.apply(this,arguments)},activate:function(){var d=OpenLayers.Control.prototype.activate.call(this);if(d){var c={displayInLayerSwitcher:false,calculateInRange:function(){return true}};this.map.addLayer(this.layer)}return d},deactivate:function(){var b=OpenLayers.Control.prototype.deactivate.call(this);if(b){if(this.layer.map!=null){this.layer.destroy(false);if(this.feature){this.feature.destroy()}}this.layer=null;this.feature=null}return b},createGeometry:function(){this.angle=Math.PI*((1/this.sides)-(1/2));if(this.snapAngle){this.angle+=this.snapAngle*(Math.PI/180)}this.feature.geometry=OpenLayers.Geometry.Polygon.createRegularPolygon(this.origin,this.radius,this.sides,this.snapAngle)},modifyGeometry:function(){var i,l,g,h;var k=this.feature.geometry.components[0];if(k.components.length!=(this.sides+1)){this.createGeometry();k=this.feature.geometry.components[0]}for(var j=0;j<this.sides;++j){h=k.components[j];i=this.angle+(j*2*Math.PI/this.sides);h.x=this.origin.x+(this.radius*Math.cos(i));h.y=this.origin.y+(this.radius*Math.sin(i));h.clearBounds()}},updateCircle:function(c,d){this.origin=new OpenLayers.Geometry.Point(c.lon,c.lat);this.radius=d*1;if(!this.feature){this.feature=new OpenLayers.Feature.Vector();this.createGeometry();this.layer.addFeatures([this.feature],{silent:true})}else{this.modifyGeometry()}this.layer.drawFeature(this.feature,this.style)},CLASS_NAME:"Meteorage.Circle"});OpenLayers.Control.newSelectFeature=OpenLayers.Class(OpenLayers.Control,{multipleKey:null,toggleKey:null,multiple:false,clickout:true,toggle:false,hover:false,onSelect:function(){},onUnselect:function(){},onHoverSelect:function(){},onHoverUnselect:function(){},onClickSelect:function(){},onClickUnselect:function(){},geometryTypes:null,layer:null,callbacks:null,selectStyle:null,renderIntent:"select",handler:null,initialize:function(c,b){OpenLayers.Control.prototype.initialize.apply(this,[b]);this.layer=c;this.callbacks=OpenLayers.Util.extend({click:this.clickFeature,clickout:this.clickoutFeature,over:this.overFeature,out:this.outFeature},this.callbacks);var a={geometryTypes:this.geometryTypes};this.handler=new OpenLayers.Handler.Feature(this,c,this.callbacks,a)},unselectAll:function(a){var c;for(var b=this.layer.selectedFeatures.length-1;b>=0;--b){c=this.layer.selectedFeatures[b];if(!a||a.except!=c){this.unselect(c,"click")}}},clickFeature:function(a){if((this.onSelect.name!=""||this.onClickSelect.name!="")&&!this.hover){var b=(OpenLayers.Util.indexOf(this.layer.selectedFeatures,a)>-1);if(b){if(this.toggleSelect()){this.unselect(a)}else{if(!this.multipleSelect()){this.unselectAll({except:a})}}}else{if(!this.multipleSelect()){this.unselectAll({except:a})}}this.select(a,"click")}},multipleSelect:function(){return this.multiple||this.handler.evt[this.multipleKey]},toggleSelect:function(){return this.toggle||this.handler.evt[this.toggleKey]},clickoutFeature:function(a){if(((this.onClickUnselect.name!=""||this.onHoverSelect.name=="")&&!this.hover)&&this.clickout){this.unselectAll()}},overFeature:function(a){if((this.onHoverSelect.name!=""||this.hover)&&(OpenLayers.Util.indexOf(this.layer.selectedFeatures,a)==-1)){this.select(a,"hover")}},outFeature:function(a){if(this.onHoverUnselect.name!=""||this.hover){this.unselect(a,"hover")}},select:function(c,a){this.layer.selectedFeatures.push(c);var b=this.selectStyle||this.renderIntent;this.layer.drawFeature(c,b);this.layer.events.triggerEvent("featureselected",{feature:c});switch(a){case"hover":this.onHoverSelect(c);break;case"click":if(this.onClickSelect.name!=""){this.onClickSelect(c)}else{if(this.onSelect.name!=""){this.onSelect(c)}}break;default:this.onSelect(c);break}},unselect:function(b,a){this.layer.drawFeature(b,"default");OpenLayers.Util.removeItem(this.layer.selectedFeatures,b);this.layer.events.triggerEvent("featureunselected",{feature:b});switch(a){case"hover":this.onHoverUnselect(b);break;case"click":if(this.onClickUnselect.name!=""){this.onClickUnselect(b)}else{if(this.onUnselect.name!=""){this.onUnselect(b)}}break;default:this.onUnselect(b);break}},setMap:function(a){this.handler.setMap(a);OpenLayers.Control.prototype.setMap.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.newSelectFeature"});Ext.define("GeoExt.data.LayerModel",{alternateClassName:"GeoExt.data.LayerRecord",extend:"Ext.data.Model",requires:["Ext.data.proxy.Memory","Ext.data.reader.Json"],alias:"model.gx_layer",statics:{createFromLayer:function(b){return this.proxy.reader.readRecords([b]).records[0]}},fields:["id",{name:"title",type:"string",mapping:"name"},{name:"legendURL",type:"string",mapping:"metadata.legendURL"},{name:"hideTitle",type:"bool",mapping:"metadata.hideTitle"},{name:"hideInLegend",type:"bool",mapping:"metadata.hideInLegend"}],proxy:{type:"memory",reader:{type:"json"}},getLayer:function(){return this.raw}});Ext.define("GeoExt.data.LayerStore",{requires:["GeoExt.data.LayerModel"],extend:"Ext.data.Store",model:"GeoExt.data.LayerModel",statics:{MAP_TO_STORE:1,STORE_TO_MAP:2},map:null,constructor:function(e){var h=this;e=Ext.apply({},e);var g=(GeoExt.MapPanel&&e.map instanceof GeoExt.MapPanel)?e.map.map:e.map;delete e.map;if(e.layers){e.data=e.layers}delete e.layers;var f={initDir:e.initDir};delete e.initDir;h.callParent([e]);if(g){this.bind(g,f)}},bind:function(h,g){var f=this;if(f.map){return}f.map=h;g=Ext.apply({},g);var j=g.initDir;if(g.initDir==undefined){j=GeoExt.data.LayerStore.MAP_TO_STORE|GeoExt.data.LayerStore.STORE_TO_MAP}var i=h.layers.slice(0);if(j&GeoExt.data.LayerStore.STORE_TO_MAP){f.each(function(a){f.map.addLayer(a.getLayer())},f)}if(j&GeoExt.data.LayerStore.MAP_TO_STORE){f.loadRawData(i,true)}h.events.on({changelayer:f.onChangeLayer,addlayer:f.onAddLayer,removelayer:f.onRemoveLayer,scope:f});f.on({load:f.onLoad,clear:f.onClear,add:f.onAdd,remove:f.onRemove,update:f.onUpdate,scope:f});f.data.on({replace:f.onReplace,scope:f});f.fireEvent("bind",f,h)},unbind:function(){var b=this;if(b.map){b.map.events.un({changelayer:b.onChangeLayer,addlayer:b.onAddLayer,removelayer:b.onRemoveLayer,scope:b});b.un("load",b.onLoad,b);b.un("clear",b.onClear,b);b.un("add",b.onAdd,b);b.un("remove",b.onRemove,b);b.data.un("replace",b.onReplace,b);b.map=null}},onChangeLayer:function(f){var h=f.layer;var j=this.findBy(function(b,a){return b.getLayer()===h});if(j>-1){var g=this.getAt(j);if(f.property==="order"){if(!this._adding&&!this._removing){var i=this.map.getLayerIndex(h);if(i!==j){this._removing=true;this.remove(g);delete this._removing;this._adding=true;this.insert(i,[g]);delete this._adding}}}else{if(f.property==="name"){g.set("title",h.name)}else{this.fireEvent("update",this,g,Ext.data.Record.EDIT)}}}},onAddLayer:function(d){var f=this;if(!f._adding){f._adding=true;var e=f.proxy.reader.read(d.layer);f.add(e.records);delete f._adding}},onRemoveLayer:function(d){if(this.map.unloadDestroy){if(!this._removing){var c=d.layer;this._removing=true;this.remove(this.getByLayer(c));delete this._removing}}else{this.unbind()}},onLoad:function(n,h,j){if(j){if(!Ext.isArray(h)){h=[h]}if(!this._addRecords){this._removing=true;for(var l=this.map.layers.length-1;l>=0;l--){this.map.removeLayer(this.map.layers[l])}delete this._removing}var i=h.length;if(i>0){var k=new Array(i);for(var m=0;m<i;m++){k[m]=h[m].getLayer()}this._adding=true;this.map.addLayers(k);delete this._adding}}delete this._addRecords},onClear:function(d){this._removing=true;for(var c=this.map.layers.length-1;c>=0;c--){this.map.removeLayer(this.map.layers[c])}delete this._removing},onAdd:function(f,g,j){if(!this._adding){this._adding=true;var h;for(var i=g.length-1;i>=0;--i){h=g[i].getLayer();this.map.addLayer(h);if(j!==this.map.layers.length-1){this.map.setLayerIndex(h,j)}}delete this._adding}},onRemove:function(e,f,h){if(!this._removing){var g=f.getLayer();if(this.map.getLayer(g.id)!=null){this._removing=true;this.removeMapLayer(f);delete this._removing}}},onUpdate:function(j,g,f){if(f===Ext.data.Record.EDIT){if(g.modified&&g.modified.title){var i=g.getLayer();var h=g.get("title");if(h!==i.name){i.setName(h)}}}},removeMapLayer:function(b){this.map.removeLayer(b.getLayer())},onReplace:function(f,e,d){this.removeMapLayer(e)},getByLayer:function(c){var d=this.findBy(function(a){return a.getLayer()===c});if(d>-1){return this.getAt(d)}},destroy:function(){var b=this;b.unbind();b.callParent()},loadRecords:function(d,c){if(c&&c.addRecords){this._addRecords=true}this.callParent(arguments)}});Ext.define("GeoExt.panel.Map",{extend:"Ext.panel.Panel",requires:["GeoExt.data.LayerStore"],alias:"widget.gx_mappanel",alternateClassName:"GeoExt.MapPanel",statics:{guess:function(){var b=Ext.ComponentQuery.query("gx_mappanel");return((b&&b.length>0)?b[0]:null)}},center:null,zoom:null,extent:null,prettyStateKeys:false,map:null,layers:null,stateEvents:["aftermapmove","afterlayervisibilitychange","afterlayeropacitychange","afterlayerorderchange","afterlayernamechange","afterlayeradd","afterlayerremove"],initComponent:function(){if(!(this.map instanceof OpenLayers.Map)){this.map=new OpenLayers.Map(Ext.applyIf(this.map||{},{allOverlays:true}))}var b=this.layers;if(!b||b instanceof Array){this.layers=Ext.create("GeoExt.data.LayerStore",{layers:b,map:this.map.layers.length>0?this.map:null})}if(Ext.isString(this.center)){this.center=OpenLayers.LonLat.fromString(this.center)}else{if(Ext.isArray(this.center)){this.center=new OpenLayers.LonLat(this.center[0],this.center[1])}}if(Ext.isString(this.extent)){this.extent=OpenLayers.Bounds.fromString(this.extent)}else{if(Ext.isArray(this.extent)){this.extent=OpenLayers.Bounds.fromArray(this.extent)}}this.callParent(arguments);this.on("resize",this.onResize,this);this.on("afterlayout",function(){if(typeof this.map.getViewport==="function"){this.items.each(function(a){if(typeof a.addToMapPanel==="function"){a.getEl().appendTo(this.map.getViewport())}},this)}},this);this.map.events.on({moveend:this.onMoveend,changelayer:this.onChangelayer,addlayer:this.onAddlayer,removelayer:this.onRemovelayer,scope:this})},onMoveend:function(b){this.fireEvent("aftermapmove",this,this.map,b)},onChangelayer:function(c){var d=this.map;if(c.property){if(c.property==="visibility"){this.fireEvent("afterlayervisibilitychange",this,d,c)}else{if(c.property==="order"){this.fireEvent("afterlayerorderchange",this,d,c)}else{if(c.property==="nathis"){this.fireEvent("afterlayernathischange",this,d,c)}else{if(c.property==="opacity"){this.fireEvent("afterlayeropacitychange",this,d,c)}}}}}},onAddlayer:function(){this.fireEvent("afterlayeradd")},onRemovelayer:function(){this.fireEvent("afterlayerremove")},onResize:function(){var b=this.map;if(this.body.dom!==b.div){b.render(this.body.dom);this.layers.bind(b);if(b.layers.length>0){this.setInitialExtent()}else{this.layers.on("add",this.setInitialExtent,this,{single:true})}}else{b.updateSize()}},setInitialExtent:function(){var b=this.map;if(!b.getCenter()){if(this.center||this.zoom){b.setCenter(this.center,this.zoom)}else{if(this.extent instanceof OpenLayers.Bounds){b.zoomToExtent(this.extent,true)}else{b.zoomToMaxExtent()}}}},getState:function(){var j=this,h=j.map,i=j.callParent(arguments)||{},f;if(!h){return}var g=h.getCenter();g&&Ext.applyIf(i,{x:g.lon,y:g.lat,zoom:h.getZoom()});j.layers.each(function(a){f=a.getLayer();layerId=this.prettyStateKeys?a.get("title"):a.get("id");i=j.addPropertyToState(i,"visibility_"+layerId,f.getVisibility());i=j.addPropertyToState(i,"opacity_"+layerId,(f.opacity===null)?1:f.opacity)},j);return i},applyState:function(r){var i=this;map=i.map;i.center=new OpenLayers.LonLat(r.x,r.y);i.zoom=r.zoom;var m,p,l,o,q,k;var n=map.layers;for(m=0,p=n.length;m<p;m++){l=n[m];o=i.prettyStateKeys?l.name:l.id;q=r["visibility_"+o];if(q!==undefined){q=(/^true$/i).test(q);if(l.isBaseLayer){if(q){map.setBaseLayer(l)}}else{l.setVisibility(q)}}k=r["opacity_"+o];if(k!==undefined){l.setOpacity(k)}}},onBeforeAdd:function(b){if(Ext.isFunction(b.addToMapPanel)){b.addToMapPanel(this)}this.callParent(arguments)},beforeDestroy:function(){if(this.map&&this.map.events){this.map.events.un({moveend:this.onMoveend,changelayer:this.onChangelayer,scope:this})}if(!this.initialConfig.map||!(this.initialConfig.map instanceof OpenLayers.Map)){if(this.map&&this.map.destroy){this.map.destroy()}}delete this.map;this.callParent(arguments)}});Ext.define("GeoExt.tree.Column",{extend:"Ext.tree.Column",alias:"widget.gx_treecolumn",initComponent:function(){var c=this;c.callParent();var d=c.renderer;this.renderer=function(b,n,o,k,a,m,p){var l=[d(b,n,o,k,a,m,p)];if(o.get("checkedGroup")){l[0]=l[0].replace(/class="([^-]+)-tree-checkbox([^"]+)?"/,'class="$1-tree-checkbox$2 gx-tree-radio"')}l.push('<div class="gx-tree-component gx-tree-component-off" id="tree-record-'+o.id+'"></div>');if(o.uiProvider&&o.uiProvider instanceof "string"){}return l.join("")}},defaultRenderer:function(b){return b}});Ext.define("GeoExt.tree.View",{extend:"Ext.tree.View",alias:"widget.gx_treeview",initComponent:function(){var b=this;b.on("itemupdate",this.onItem,this);b.on("itemadd",this.onItem,this);b.on("createchild",this.createChild,this);return b.callParent(arguments)},onItem:function(h,l,i,g){var j=this;if(!(h instanceof Array)){h=[h]}for(var k=0;k<h.length;k++){this.onNodeRendered(h[k])}},onNodeRendered:function(f){var d=this;var e=Ext.get("tree-record-"+f.id);if(!e){return}if(f.get("layer")){d.fireEvent("createchild",e,f)}if(f.hasChildNodes()){f.eachChild(function(a){d.onNodeRendered(a)},d)}},createChild:function(d,f){var e=f.get("component");if(e){cmpObj=Ext.ComponentManager.create(e);cmpObj.render(d);d.removeCls("gx-tree-component-off")}}});Ext.define("GeoExt.tree.LayerNode",{extend:"Ext.AbstractPlugin",alias:"plugin.gx_layer",init:function(c){this.target=c;var d=c.get("layer");c.set("checked",d.getVisibility());if(!c.get("checkedGroup")&&d.isBaseLayer){c.set("checkedGroup","gx_baselayer")}c.set("fixedText",!!c.text);c.set("leaf",true);if(!c.get("iconCls")){c.set("iconCls","gx-tree-layer-icon")}c.on("afteredit",this.onAfterEdit,this);d.events.on({visibilitychanged:this.onLayerVisibilityChanged,scope:this})},onAfterEdit:function(f,e){var d=this;if(~Ext.Array.indexOf(e,"checked")){d.onCheckChange()}},onLayerVisibilityChanged:function(){if(!this._visibilityChanging){this.target.set("checked",this.target.get("layer").getVisibility())}},onCheckChange:function(){var f=this.target,d=this.target.get("checked");if(d!=f.get("layer").getVisibility()){f._visibilityChanging=true;var e=f.get("layer");if(d&&e.isBaseLayer&&e.map){e.map.setBaseLayer(e)}else{e.setVisibility(d)}delete f._visibilityChanging}}});Ext.define("GeoExt.tree.LayerLoader",{extend:"Ext.util.Observable",requires:["GeoExt.tree.LayerNode"],store:null,filter:function(b){return b.getLayer().displayInLayerSwitcher===true},baseAttrs:null,load:function(b){if(this.fireEvent("beforeload",this,b)){this.removeStoreHandlers();while(b.firstChild){b.removeChild(b.firstChild)}if(!this.store){this.store=GeoExt.MapPanel.guess().layers}this.store.each(function(a){this.addLayerNode(b,a)},this);this.addStoreHandlers(b);this.fireEvent("load",this,b)}},onStoreAdd:function(h,i,n,k){if(!this._reordering){var j=k.get("container").recordIndexToNodeIndex(n+i.length-1,k);for(var m=0,l=i.length;m<l;++m){this.addLayerNode(k,i[m],j)}}},onStoreRemove:function(d,c){if(!this._reordering){this.removeLayerNode(c,d)}},addLayerNode:function(i,g,f){f=f||0;if(this.filter(g)===true){var j=g.getLayer();var h=this.createNode({plugins:[{ptype:"gx_layer"}],layer:j,text:j.name,listeners:{move:this.onChildMove,scope:this}});if(f!==undefined){i.insertChild(f,h)}else{i.appendChild(h)}i.getChildAt(f).on("move",this.onChildMove,this)}},removeLayerNode:function(d,e){if(this.filter(e)===true){var f=d.findChildBy(function(a){return a.get("layer")==e.getLayer()});if(f){f.un("move",this.onChildMove,this);f.remove()}}},onChildMove:function(v,n,m,q){var p=this,r=p.store.getByLayer(v.get("layer")),w=m.get("container"),s=w.loader;p._reordering=true;if(s instanceof p.self&&p.store===s.store){s._reordering=true;p.store.remove(r);var x;if(m.childNodes.length>1){var o=(q===0)?q+1:q-1;x=p.store.findBy(function(a){return m.childNodes[o].get("layer")===a.getLayer()});if(q===0){x++}}else{if(n.parentNode===m.parentNode){var u=m;do{u=u.previousSibling}while(u&&!(u.get("container") instanceof w.self&&u.lastChild));if(u){x=p.store.findBy(function(a){return u.lastChild.get("layer")===a.getLayer()})}else{var t=m;do{t=t.nextSibling}while(t&&!(t.get("container") instanceof w.self&&t.firstChild));if(t){x=p.store.findBy(function(a){return t.firstChild.get("layer")===a.getLayer()})}x++}}}if(x!==undefined){p.store.insert(x,[r])}else{p.store.insert(oldRecordIndex,[r])}delete s._reordering}delete p._reordering},addStoreHandlers:function(c){if(!this._storeHandlers){this._storeHandlers={add:function(f,a,b){this.onStoreAdd(f,a,b,c)},remove:function(b,a){this.onStoreRemove(a,c)}};for(var d in this._storeHandlers){this.store.on(d,this._storeHandlers[d],this)}}},removeStoreHandlers:function(){if(this._storeHandlers){for(var b in this._storeHandlers){this.store.un(b,this._storeHandlers[b],this)}delete this._storeHandlers}},createNode:function(b){if(this.baseAttrs){Ext.apply(b,this.baseAttrs)}return b},destroy:function(){this.removeStoreHandlers()}});Ext.define("GeoExt.tree.LayerContainer",{extend:"Ext.AbstractPlugin",requires:["GeoExt.tree.LayerLoader"],alias:"plugin.gx_layercontainer",defaultText:"Layers",init:function(f){var d=this;var e=d.loader;d.loader=(e&&e instanceof GeoExt.tree.LayerLoader)?e:new GeoExt.tree.LayerLoader(e);f.set("container",d);if(!f.get("text")){f.set("text",d.defaultText);f.commit()}d.loader.load(f)},recordIndexToNodeIndex:function(p,l){var m=this;var i=m.loader.store;var n=i.getCount();var j=l.childNodes.length;var k=-1;for(var o=n-1;o>=0;--o){if(m.loader.filter(i.getAt(o))===true){++k;if(p===o||k>j-1){break}}}return k}});Ext.define("GeoExt.tree.BaseLayerContainer",{extend:"GeoExt.tree.LayerContainer",alias:"plugin.gx_baselayercontainer",defaultText:"Base Layers",init:function(f){var d=this;var e=d.loader;d.loader=Ext.applyIf(e||{},{baseAttrs:Ext.applyIf((e&&e.baseAttrs)||{},{iconCls:"gx-tree-baselayer-icon",checkedGroup:"baselayer"}),filter:function(b){var a=b.getLayer();return a.displayInLayerSwitcher===true&&a.isBaseLayer===true}});d.callParent(arguments)}});Ext.define("GeoExt.tree.Panel",{extend:"Ext.tree.Panel",alias:"widget.gx_treepanel",requires:["GeoExt.tree.Column","GeoExt.tree.View"],viewType:"gx_treeview",initComponent:function(){var b=this;if(!b.columns){if(b.initialConfig.hideHeaders===undefined){b.hideHeaders=true}b.addCls(Ext.baseCSSPrefix+"autowidth-table");b.columns=[{xtype:"gx_treecolumn",text:"Name",width:Ext.isIE6?null:10000,dataIndex:b.displayField}]}b.callParent()}});Ext.Ajax.method="GET";GIS={core:{instances:[]},i18n:{},isDebug:false,isSessionStorage:"sessionStorage" in window&&window.sessionStorage!==null,logg:[]};GIS.core.getOLMap=function(b){var c,a;a=function(e,g){var f,d;f=new OpenLayers.Control.Button({displayClass:"olControlButton",trigger:function(){g.call(b.olmap)}});d=new OpenLayers.Control.Panel({defaultControl:f});d.addControls([f]);c.addControl(d);d.div.className+=" "+e;d.div.childNodes[0].className+=" "+e+"Button"};c=new OpenLayers.Map({controls:[new OpenLayers.Control.Navigation({zoomWheelEnabled:false,documentDrag:true}),new OpenLayers.Control.MousePosition({prefix:'<span id="mouseposition" class="el-fontsize-10"><span class="text-mouseposition-lonlat">LON </span>',separator:'<span class="text-mouseposition-lonlat">,&nbsp;LAT </span>',suffix:'<div id="google-logo" name="http://www.google.com/intl/en-US_US/help/terms_maps.html" onclick="window.open(Ext.get(this).dom.attributes.name.nodeValue);"></div></span>'}),new OpenLayers.Control.Permalink(),new OpenLayers.Control.ScaleLine({geodesic:true,maxWidth:170,minWidth:100})],displayProjection:new OpenLayers.Projection("EPSG:4326"),maxExtent:new OpenLayers.Bounds(-20037508,-20037508,20037508,20037508),mouseMove:{},relocate:{}});c.events.register("mousemove",null,function(d){b.olmap.mouseMove.x=d.clientX;b.olmap.mouseMove.y=d.clientY});c.zoomToVisibleExtent=function(){b.util.map.zoomToVisibleExtent(this)};c.closeAllLayers=function(){b.layer.boundary.core.reset();b.layer.thematic1.core.reset();b.layer.thematic2.core.reset();b.layer.thematic3.core.reset();b.layer.thematic4.core.reset();b.layer.facility.core.reset()};a("zoomIn",c.zoomIn);a("zoomOut",c.zoomOut);a("zoomVisible",c.zoomToVisibleExtent);a("measure",function(){GIS.core.MeasureWindow(b).show()});return c};GIS.core.getLayers=function(a){var f={},b,d=["1","2","3","4"];if(window.google){f.googleStreets=new OpenLayers.Layer.Google("Google Streets",{numZoomLevels:20,animationEnabled:true,layerType:a.conf.finals.layer.type_base,layerOpacity:1,setLayerOpacity:function(g){if(g){this.layerOpacity=parseFloat(g)}this.setOpacity(this.layerOpacity)}});f.googleStreets.id="googleStreets";f.googleHybrid=new OpenLayers.Layer.Google("Google Hybrid",{type:google.maps.MapTypeId.HYBRID,numZoomLevels:20,animationEnabled:true,layerType:a.conf.finals.layer.type_base,layerOpacity:1,setLayerOpacity:function(g){if(g){this.layerOpacity=parseFloat(g)}this.setOpacity(this.layerOpacity)}});f.googleHybrid.id="googleHybrid"}f.openStreetMap=new OpenLayers.Layer.OSM.Mapnik("OpenStreetMap",{layerType:a.conf.finals.layer.type_base,layerOpacity:1,setLayerOpacity:function(g){if(g){this.layerOpacity=parseFloat(g)}this.setOpacity(this.layerOpacity)}});f.openStreetMap.id="openStreetMap";f.facility=GIS.core.VectorLayer(a,"facility",GIS.i18n.facility_layer,{opacity:1});f.facility.core=new mapfish.GeoStat.Facility(a.olmap,{layer:f.facility,gis:a});f.boundary=GIS.core.VectorLayer(a,"boundary",GIS.i18n.boundary_layer,{opacity:0.8});f.boundary.core=new mapfish.GeoStat.Boundary(a.olmap,{layer:f.boundary,gis:a});for(var c=0,e;c<d.length;c++){e=d[c];f["thematic"+e]=GIS.core.VectorLayer(a,"thematic"+e,GIS.i18n.thematic_layer+" "+e,{opacity:0.8});f["thematic"+e].layerCategory=a.conf.finals.layer.category_thematic,f["thematic"+e].core=new mapfish.GeoStat["Thematic"+e](a.olmap,{layer:f["thematic"+e],gis:a})}return f};GIS.core.createSelectHandlers=function(h,b){var j=!!GIS.app?(h.init.user.isAdmin?true:false):false,c,d,g,a,i,f=h.conf.finals.dimension;g=function e(l){if(c){c.destroy()}c=Ext.create("Ext.window.Window",{cls:"gis-window-widget-feature gis-plugin",preventHeader:true,shadow:false,resizable:false,items:{html:l.attributes.label}});c.show();var o=h.viewport.eastRegion.getPosition()[0],n=h.viewport.centerRegion.getPosition()[0],m=n+((o-n)/2),k=h.viewport.centerRegion.getPosition()[1]+(GIS.app?32:0);c.setPosition(m-(c.getWidth()/2),k)};a=function e(k){c.destroy()};i=function e(s){var r,q,l,m,n,p=s.geometry.CLASS_NAME===h.conf.finals.openLayers.point_classname,o=s.attributes;q=function(){if(h.olmap.relocate.window){h.olmap.relocate.window.destroy()}h.olmap.relocate.window=Ext.create("Ext.window.Window",{title:"Relocate facility",layout:"fit",iconCls:"gis-window-title-icon-relocate",cls:"gis-container-default",setMinWidth:function(t){this.setWidth(this.getWidth()<t?t:this.getWidth())},items:{html:o.name,cls:"gis-container-inner"},bbar:["->",{xtype:"button",hideLabel:true,text:GIS.i18n.cancel,handler:function(){h.olmap.relocate.active=false;h.olmap.relocate.window.destroy();h.olmap.getViewport().style.cursor="auto"}}],listeners:{close:function(){h.olmap.relocate.active=false;h.olmap.getViewport().style.cursor="auto"}}});h.olmap.relocate.window.show();h.olmap.relocate.window.setMinWidth(220);h.util.gui.window.setPositionTopRight(h.olmap.relocate.window)};r=function(){Ext.Ajax.request({url:h.init.contextPath+h.conf.finals.url.path_module+"getFacilityInfo.action",params:{id:o.id},success:function(u){var t=Ext.decode(u.responseText);if(b.infrastructuralWindow){b.infrastructuralWindow.destroy()}b.infrastructuralWindow=Ext.create("Ext.window.Window",{title:GIS.i18n.information,layout:"column",iconCls:"gis-window-title-icon-information",cls:"gis-container-default",width:460,height:400,period:null,items:[{cls:"gis-container-inner",columnWidth:0.4,bodyStyle:"padding-right:4px",items:function(){var v=[];if(o.name){v.push({html:GIS.i18n.name,cls:"gis-panel-html-title"},{html:o.name,cls:"gis-panel-html"},{cls:"gis-panel-html-separator"})}if(t.pa){v.push({html:GIS.i18n.parent_unit,cls:"gis-panel-html-title"},{html:t.pa,cls:"gis-panel-html"},{cls:"gis-panel-html-separator"})}if(t.ty){v.push({html:GIS.i18n.type,cls:"gis-panel-html-title"},{html:t.ty,cls:"gis-panel-html"},{cls:"gis-panel-html-separator"})}if(t.co){v.push({html:GIS.i18n.code,cls:"gis-panel-html-title"},{html:t.co,cls:"gis-panel-html"},{cls:"gis-panel-html-separator"})}if(t.ad){v.push({html:GIS.i18n.address,cls:"gis-panel-html-title"},{html:t.ad,cls:"gis-panel-html"},{cls:"gis-panel-html-separator"})}if(t.em){v.push({html:GIS.i18n.email,cls:"gis-panel-html-title"},{html:t.em,cls:"gis-panel-html"},{cls:"gis-panel-html-separator"})}if(t.pn){v.push({html:GIS.i18n.phone_number,cls:"gis-panel-html-title"},{html:t.pn,cls:"gis-panel-html"},{cls:"gis-panel-html-separator"})}return v}()},{xtype:"form",cls:"gis-container-inner gis-form-widget",columnWidth:0.6,bodyStyle:"padding-left:4px",items:[{html:GIS.i18n.infrastructural_data,cls:"gis-panel-html-title"},{cls:"gis-panel-html-separator"},{xtype:"combo",fieldLabel:GIS.i18n.period,editable:false,valueField:"id",displayField:"name",forceSelection:true,width:255,labelWidth:70,store:h.store.infrastructuralPeriodsByType,lockPosition:false,listeners:{select:function(){d=this.getValue();b.widget.infrastructuralDataElementValuesStore.load({params:{periodId:d,organisationUnitId:o.internalId}})}}},{cls:"gis-panel-html-separator"},{xtype:"grid",cls:"gis-grid",height:300,width:255,scroll:"vertical",columns:[{id:"dataElementName",text:"Data element",dataIndex:"dataElementName",sortable:true,width:195},{id:"value",header:"Value",dataIndex:"value",sortable:true,width:60}],disableSelection:true,store:b.widget.infrastructuralDataElementValuesStore}]}],listeners:{show:function(){if(d){this.down("combo").setValue(d);infrastructuralDataElementValuesStore.load({params:{periodId:d,organisationUnitId:o.internalId}})}}}});b.infrastructuralWindow.show();h.util.gui.window.setPositionTopRight(b.infrastructuralWindow)}})};l=function(x,v,w){var u=Ext.clone(b.core.view),t;u.parentGraphMap={};u.parentGraphMap[x]=v;u.rows=[{dimension:f.organisationUnit.objectName,items:[{id:x},{id:"LEVEL-"+w}]}];if(u){t=b.core.getLoader();t.updateGui=true;t.zoomToVisibleExtent=true;t.hideMask=true;t.load(u)}};var k=[Ext.create("Ext.menu.Item",{text:"Float up",iconCls:"gis-menu-item-icon-float",cls:"gis-plugin",disabled:!o.hasCoordinatesUp,handler:function(){l(o.grandParentId,o.grandParentParentGraph,parseInt(o.level)-1)}}),Ext.create("Ext.menu.Item",{text:"Drill down",iconCls:"gis-menu-item-icon-drill",cls:"gis-menu-item-first gis-plugin",disabled:!o.hasCoordinatesDown,handler:function(){l(o.id,o.parentGraph,parseInt(o.level)+1)}})];if(j&&p){k.push({xtype:"menuseparator"});k.push(Ext.create("Ext.menu.Item",{text:GIS.i18n.relocate,iconCls:"gis-menu-item-icon-relocate",disabled:!h.init.user.isAdmin,handler:function(t){h.olmap.relocate.active=true;h.olmap.relocate.feature=s;h.olmap.getViewport().style.cursor="crosshair";q()}}));k.push(Ext.create("Ext.menu.Item",{text:GIS.i18n.show_information_sheet,iconCls:"gis-menu-item-icon-information",handler:function(t){if(h.store.infrastructuralPeriodsByType.isLoaded){r()}else{h.store.infrastructuralPeriodsByType.load({params:{name:h.init.systemSettings.infrastructuralPeriodType},callback:function(){r()}})}}}))}k[k.length-1].addCls("gis-menu-item-last");m=new Ext.menu.Menu({baseCls:"gis-plugin",shadow:false,showSeparator:false,defaults:{bodyStyle:"padding-right:6px"},items:k,listeners:{afterrender:function(){this.getEl().addCls("gis-toolbar-btn-menu")}}});m.showAt([h.olmap.mouseMove.x,h.olmap.mouseMove.y])};selectHandlers=new OpenLayers.Control.newSelectFeature(b,{onHoverSelect:g,onHoverUnselect:a,onClickSelect:i});h.olmap.addControl(selectHandlers);selectHandlers.activate()};GIS.core.OrganisationUnitLevelStore=function(a){return Ext.create("Ext.data.Store",{fields:["id","name","level"],proxy:{type:"jsonp",url:a.init.contextPath+a.conf.finals.url.path_api+"organisationUnitLevels.jsonp?viewClass=detailed&links=false&paging=false",reader:{type:"json",root:"organisationUnitLevels"}},autoLoad:true,cmp:[],isLoaded:false,loadFn:function(b){if(this.isLoaded){b.call()}else{this.load(b)}},getRecordByLevel:function(b){return this.getAt(this.findExact("level",b))},listeners:{load:function(){if(!this.isLoaded){this.isLoaded=true;a.util.gui.combo.setQueryMode(this.cmp,"local")}this.sort("level","ASC")}}})};GIS.core.StyleMap=function(d,b){var c={fillOpacity:1,strokeColor:"#fff",strokeWidth:1},a={fillOpacity:0.9,strokeColor:"#fff",strokeWidth:1,cursor:"pointer"};if(d==="boundary"){c.fillOpacity=0;c.strokeColor="#000";c.strokeWidth=1;a.fillColor="#000";a.fillOpacity=0.15;a.strokeColor="#000";a.strokeWidth=1}if(b){c.label="${label}";c.fontFamily="arial,sans-serif,ubuntu,consolas";c.fontSize=b.fontSize?b.fontSize+"px":"13px";c.fontWeight=b.strong?"bold":"normal";c.fontStyle=b.italic?"italic":"normal";c.fontColor=b.color?(b.color.split("").shift()!=="#"?"#"+b.color:b.color):"#000000"}return new OpenLayers.StyleMap({"default":c,select:a})};GIS.core.VectorLayer=function(a,e,c,b){var d=new OpenLayers.Layer.Vector(c,{strategies:[new OpenLayers.Strategy.Refresh({force:true})],styleMap:GIS.core.StyleMap(e),visibility:false,displayInLayerSwitcher:false,layerType:a.conf.finals.layer.type_vector,layerOpacity:b?b.opacity||1:1,setLayerOpacity:function(f){if(f){this.layerOpacity=parseFloat(f)}this.setOpacity(this.layerOpacity)},hasLabels:false});d.id=e;return d};GIS.core.MeasureWindow=function(a){var c,b,d,f,e;e=new OpenLayers.StyleMap({"default":new OpenLayers.Style()});f=new OpenLayers.Control.Measure(OpenLayers.Handler.Path,{persist:true,immediate:true,handlerOption:{layerOptions:{styleMap:e}}});d=function(g){if(g.measure){b.setText(g.measure.toFixed(2)+" "+g.units)}};a.olmap.addControl(f);f.events.on({measurepartial:d,measure:d});f.geodesic=true;f.activate();b=Ext.create("Ext.form.Label",{style:"height: 20px",text:"0 km"});c=Ext.create("Ext.window.Window",{title:GIS.i18n.measure_distance,layout:"fit",cls:"gis-container-default gis-plugin",bodyStyle:"text-align: center",width:130,minWidth:130,resizable:false,items:b,listeners:{show:function(){var g=a.viewport.eastRegion.getPosition()[0]-this.getWidth()-3,h=a.viewport.centerRegion.getPosition()[1]+26;this.setPosition(g,h)},destroy:function(){f.deactivate();a.olmap.removeControl(f)}}});return c};GIS.core.MapLoader=function(b){var f,d,g,e,c=[],a;f=function(){Ext.data.JsonP.request({url:b.init.contextPath+b.conf.finals.url.path_api+"maps/"+b.map.id+".jsonp?viewClass=dimensional&links=false",success:function(p){if(Ext.isArray(p.mapViews)){for(var n=0,h;n<p.mapViews.length;n++){h=p.mapViews[n];if(h){if(Ext.isArray(h.columns)&&h.columns.length){for(var m=0,q;m<h.columns.length;m++){q=h.columns[m];if(Ext.isArray(q.items)&&q.items.length){for(var l=0,o;l<q.items.length;l++){o=q.items[l];o.id=o.id.replace(".","-")}}}}}}}b.map=p;d()},failure:function(){b.olmap.mask.hide();alert("Map id not recognized"+(b.el?" ("+b.el+")":""));return}})};d=function(){var j=b.map.mapViews,h;if(!(Ext.isArray(j)&&j.length)){b.olmap.mask.hide();alert(GIS.i18n.favorite_outdated_create_new);return}for(var k=0;k<j.length;k++){j[k]=b.api.layout.Layout(j[k])}j=Ext.Array.clean(j);if(!j.length){return}if(b.viewport&&b.viewport.favoriteWindow&&b.viewport.favoriteWindow.isVisible()){b.viewport.favoriteWindow.destroy()}b.olmap.closeAllLayers();for(var k=0,l;k<j.length;k++){l=j[k];h=b.layer[l.layer].core.getLoader();h.updateGui=!b.el;h.callBack=e;h.load(l)}};e=function(h){c.push(h);if(c.length===b.map.mapViews.length){g()}};g=function(){c=[];if(b.el){b.olmap.zoomToVisibleExtent()}else{if(b.map.longitude&&b.map.latitude&&b.map.zoom){b.olmap.setCenter(new OpenLayers.LonLat(b.map.longitude,b.map.latitude),b.map.zoom)}else{b.olmap.zoomToVisibleExtent()}}if(b.viewport.interpretationButton){b.viewport.interpretationButton.enable()}b.olmap.mask.hide()};a={load:function(h){b.olmap.mask.show();if(b.map&&b.map.id){f()}else{if(h){b.map={mapViews:h}}d()}}};return a};GIS.core.LayerLoaderBoundary=function(i,c){var b=c.map,d,f,e,a,h,g;d=function(l,o){var q=c.core.view,p,k,j,m;if(!q){if(o){f(l)}return i.conf.finals.widget.loadtype_organisationunit}p=[];k=l.rows[0];j=[];m=q.rows[0];if(k.items.length===m.items.length){for(var n=0;n<k.items.length;n++){p.push(k.items[n].id)}for(var n=0;n<m.items.length;n++){j.push(m.items[n].id)}if(Ext.Array.difference(p,j).length!==0){if(o){f(l)}return i.conf.finals.widget.loadtype_organisationunit}}else{if(o){f(l)}return i.conf.finals.widget.loadtype_organisationunit}i.olmap.mask.hide()};f=function(j){var k=j.rows[0].items,m="";for(var l=0;l<k.length;l++){m+="ids="+k[l].id;m+=l!==k.length-1?"&":""}Ext.data.JsonP.request({url:i.init.contextPath+i.conf.finals.url.path_module+"getGeoJson.action?"+m,scope:this,disableCaching:false,success:function(p){var n=i.util.geojson.decode(p),q=new OpenLayers.Format.GeoJSON(),o=i.util.map.getTransformedFeatureArray(q.read(n));if(!Ext.isArray(o)){b.mask.hide();alert(GIS.i18n.invalid_coordinates);return}if(!o.length){b.mask.hide();alert(GIS.i18n.no_valid_coordinates_found);return}e(j,o)},failure:function(n){b.mask.hide();alert(GIS.i18n.coordinates_could_not_be_loaded)}})};e=function(j,l){j=j||c.core.view;l=l||c.features.slice(0);for(var k=0;k<l.length;k++){l[k].attributes.label=l[k].attributes.name;l[k].attributes.value=0}c.removeFeatures(c.features);c.addFeatures(l);c.core.featureStore.loadFeatures(c.features.slice(0));a(j)};a=function(j){j=j||c.core.view;var k={indicator:i.conf.finals.widget.value,method:2,numClasses:5,colors:c.core.getColors("000000","000000"),minSize:6,maxSize:6};if(j.labels){if(Ext.isObject(j.labels)){c.styleMap=GIS.core.StyleMap(c.id,j.labels)}else{c.styleMap=GIS.core.StyleMap(c.id,{fontSize:12,strong:false,italic:false,color:"#000"})}}c.core.view=j;c.core.applyClassification(k);h(j)};h=function(j){if(c.item){c.item.setValue(true,j.opacity)}else{c.setLayerOpacity(j.opacity)}if(g.updateGui&&Ext.isObject(c.widget)){c.widget.setGui(j)}if(g.zoomToVisibleExtent){b.zoomToVisibleExtent()}if(g.hideMask){b.mask.hide()}if(g.callBack){g.callBack(c)}else{i.map=null;i.viewport.interpretationButton.disable()}};g={compare:false,updateGui:false,zoomToVisibleExtent:false,hideMask:false,callBack:null,load:function(j){i.olmap.mask.show();if(this.compare){d(j,true)}else{f(j)}},loadData:e,loadLegend:a};return g};GIS.core.LayerLoaderThematic=function(j,c){var b=c.map,d,f,e,a,i,g,h=j.conf.finals.dimension;d=function(m,p){var r=c.core.view,q,l,k,n;g.zoomToVisibleExtent=true;if(!r){if(p){f(m)}return j.conf.finals.widget.loadtype_organisationunit}q=[];l=m.rows[0];k=[];n=r.rows[0];if(l.items.length===n.items.length){for(var o=0;o<l.items.length;o++){q.push(l.items[o].id)}for(var o=0;o<n.items.length;o++){k.push(n.items[o].id)}if(Ext.Array.difference(q,k).length!==0){if(p){f(m)}return j.conf.finals.widget.loadtype_organisationunit}}else{if(p){f(m)}return j.conf.finals.widget.loadtype_organisationunit}g.zoomToVisibleExtent=false;q=[];l=m.columns[0];k=[];n=r.columns[0];if(l.items.length===n.items.length){for(var o=0;o<l.items.length;o++){q.push(l.items[o].id)}for(var o=0;o<n.items.length;o++){k.push(n.items[o].id)}if(Ext.Array.difference(q,k).length!==0){if(p){e(m)}return j.conf.finals.widget.loadtype_organisationunit}}else{if(p){e(m)}return j.conf.finals.widget.loadtype_organisationunit}q=[];l=m.filters[0];k=[];n=r.filters[0];if(l.items.length===n.items.length){for(var o=0;o<l.items.length;o++){q.push(l.items[o].id)}for(var o=0;o<n.items.length;o++){k.push(n.items[o].id)}if(Ext.Array.difference(q,k).length!==0){if(p){e(m)}return j.conf.finals.widget.loadtype_organisationunit}}else{if(p){e(m)}return j.conf.finals.widget.loadtype_organisationunit}if(p){g.zoomToVisibleExtent=false;a(m);return j.conf.finals.widget.loadtype_legend}};f=function(k){var l=k.rows[0].items,n="";for(var m=0;m<l.length;m++){n+="ids="+l[m].id;n+=m!==l.length-1?"&":""}Ext.data.JsonP.request({url:j.init.contextPath+j.conf.finals.url.path_module+"getGeoJson.action?"+n,scope:this,disableCaching:false,success:function(q){var o=j.util.geojson.decode(q),s=new OpenLayers.Format.GeoJSON(),p=j.util.map.getTransformedFeatureArray(s.read(o));if(!Ext.isArray(p)){b.mask.hide();alert(GIS.i18n.invalid_coordinates);return}if(!p.length){b.mask.hide();alert(GIS.i18n.no_valid_coordinates_found);return}e(k,p)},failure:function(o){b.mask.hide();alert(GIS.i18n.coordinates_could_not_be_loaded)}})};e=function(r,m){r=r||c.core.view;m=m||c.features.slice(0);var s=j.conf.finals.dimension,n="?",o=r.columns[0].items,k=r.columns[0].dimension===s.operand.objectName,l=r.filters[0].items,q=r.rows[0].items;n+="dimension=ou:";for(var p=0;p<q.length;p++){n+=q[p].id;n+=p<q.length-1?";":""}n+="&dimension=dx:";for(var p=0;p<o.length;p++){n+=k?o[p].id.split("-")[0]:o[p].id;n+=p<o.length-1?";":""}n+=k?"&dimension=co":"";n+="&filter=pe:";for(var p=0;p<l.length;p++){n+=l[p].id;n+=p<l.length-1?";":""}Ext.data.JsonP.request({url:j.init.contextPath+"/api/analytics.jsonp"+n,disableCaching:false,scope:this,success:function(u){var z=j.api.response.Response(u),E={},w={},B,y,D,x=[],t,C=[];if(!z){alert(GIS.i18n.current_selection_no_data);b.mask.hide();return}for(var A=0;A<z.headers.length;A++){if(z.headers[A].name===s.organisationUnit.dimensionName){B=A}else{if(z.headers[A].name===s.value.dimensionName){D=A}}}for(var A=0,v;A<m.length;A++){var v=m[A].attributes.id;E[v]=true}for(var A=0;A<z.rows.length;A++){var v=z.rows[A][B],F=parseFloat(z.rows[A][D]);w[v]=F}for(var A=0;A<m.length;A++){var G=m[A],v=G.attributes.id;if(E.hasOwnProperty(v)&&w.hasOwnProperty(v)){G.attributes.value=w[v];G.attributes.label=G.attributes.name+" ("+G.attributes.value+")";x.push(G)}}c.removeFeatures(c.features);c.addFeatures(x);c.core.featureStore.loadFeatures(c.features.slice(0));j.response=z;a(r)}})};a=function(m){var o,q,n;m=m||c.core.view;q=function(s){var x=[].concat(m.columns||[],m.rows||[],m.filters||[]),r=s.metaData;for(var u=0,y;u<x.length;u++){y=x[u];for(var t=0,w;t<y.items.length;t++){w=y.items[t];if(w.id.indexOf("-")!==-1){var v=w.id.split("-");w.name=r.names[v[0]]+" "+r.names[v[1]]}else{w.name=r.names[w.id]}}}m.filters[0].items[0].name=r.names[j.response.metaData[h.period.objectName][0]]};n=function(){q(j.response);var r={indicator:j.conf.finals.widget.value,method:m.legendSet?mapfish.GeoStat.Distribution.CLASSIFY_WITH_BOUNDS:m.method,numClasses:m.classes,bounds:o,colors:c.core.getColors(m.colorLow,m.colorHigh),minSize:m.radiusLow,maxSize:m.radiusHigh};c.core.view=m;c.core.colorInterpolation=l;c.core.applyClassification(r);i(m)};if(m.labels){if(Ext.isObject(m.labels)){c.styleMap=GIS.core.StyleMap(c.id,m.labels)}else{c.styleMap=GIS.core.StyleMap(c.id,{fontSize:12,strong:false,italic:false,color:"#000"})}}if(m.legendSet){var o=[],l=[],p=[],k=[];Ext.Ajax.request({url:j.init.contextPath+j.conf.finals.url.path_api+"mapLegendSets/"+m.legendSet.id+".json?links=false&paging=false",scope:this,success:function(t){k=Ext.decode(t.responseText).mapLegends;Ext.Array.sort(k,function(u,r){return u.startValue-r.startValue});for(var s=0;s<k.length;s++){if(o[o.length-1]!==k[s].startValue){if(o.length!==0){l.push(new mapfish.ColorRgb(240,240,240));p.push("")}o.push(k[s].startValue)}l.push(new mapfish.ColorRgb());l[l.length-1].setFromHex(k[s].color);p.push(k[s].name);o.push(k[s].endValue)}m.legendSet.names=p;m.legendSet.bounds=o;m.legendSet.colors=l;n()}})}else{n()}};i=function(k){j.viewport.eastRegion.doLayout();c.legendPanel.expand();c.setLayerOpacity(k.opacity);if(c.item){c.item.setValue(true)}if(c.filterWindow&&c.filterWindow.isVisible()){c.filterWindow.filter()}if(g.updateGui&&Ext.isObject(c.widget)){c.widget.setGui(k)}if(g.zoomToVisibleExtent){b.zoomToVisibleExtent()}if(g.hideMask){b.mask.hide()}if(g.callBack){g.callBack(c)}else{j.map=null;if(j.viewport.interpretationButton){j.viewport.interpretationButton.disable()}}};g={compare:false,updateGui:false,zoomToVisibleExtent:false,hideMask:false,callBack:null,load:function(k){j.olmap.mask.show();if(this.compare){d(k,true)}else{f(k)}},loadData:e,loadLegend:a};return g};GIS.core.LayerLoaderFacility=function(j,d){var b=d.map,e,g,f,a,c,i,h;e=function(m,p){var r=d.core.view,q,l,k,n;h.zoomToVisibleExtent=true;if(!r){if(p){g(m)}return j.conf.finals.widget.loadtype_organisationunit}q=[];l=m.rows[0];k=[];n=r.rows[0];if(l.items.length===n.items.length){for(var o=0;o<l.items.length;o++){q.push(l.items[o].id)}for(var o=0;o<n.items.length;o++){k.push(n.items[o].id)}if(Ext.Array.difference(q,k).length!==0){if(p){g(m)}return j.conf.finals.widget.loadtype_organisationunit}}else{if(p){g(m)}return j.conf.finals.widget.loadtype_organisationunit}h.zoomToVisibleExtent=false;if(m.organisationUnitGroupSet.id!==r.organisationUnitGroupSet.id){if(p){g(m)}return j.conf.finals.widget.loadtype_organisationunit}if(p){a(m);return j.conf.finals.widget.loadtype_legend}};g=function(k){var l=k.rows[0].items,n="";for(var m=0;m<l.length;m++){n+="ids="+l[m].id;n+=m!==l.length-1?"&":""}Ext.data.JsonP.request({url:j.init.contextPath+j.conf.finals.url.path_module+"getGeoJsonFacilities.action?"+n,scope:this,disableCaching:false,success:function(q){var o=d.core.decode(q),s=new OpenLayers.Format.GeoJSON(),p=j.util.map.getTransformedFeatureArray(s.read(o));if(!Ext.isArray(p)){b.mask.hide();alert(GIS.i18n.invalid_coordinates);return}if(!p.length){b.mask.hide();alert(GIS.i18n.no_valid_coordinates_found);return}f(k,p)},failure:function(o){b.mask.hide();alert(GIS.i18n.coordinates_could_not_be_loaded)}})};f=function(k,m){k=k||d.core.view;m=m||d.features.slice(0);for(var l=0;l<m.length;l++){m[l].attributes.label=m[l].attributes.name}d.removeFeatures(d.features);d.addFeatures(m);d.core.featureStore.loadFeatures(d.features.slice(0));a(k)};a=function(k){k=k||d.core.view;var l=j.store.groupsByGroupSet;l.proxy.url=j.init.contextPath+j.conf.finals.url.path_module+"getOrganisationUnitGroupsByGroupSet.action?id="+k.organisationUnitGroupSet.id;l.load({scope:this,callback:function(){var m={indicator:k.organisationUnitGroupSet.id};d.core.view=k;d.core.applyClassification(m);c(k);i(k)}})};c=function(l){var k=l.areaRadius;if(d.circleLayer){d.circleLayer.deactivateControls();d.circleLayer=null}if(Ext.isDefined(k)&&k){d.circleLayer=GIS.app.CircleLayer(d.features,k);nissa=d.circleLayer}};i=function(k){j.viewport.eastRegion.doLayout();d.legendPanel.expand();if(d.item){d.item.setValue(true,k.opacity)}else{d.setLayerOpacity(k.opacity)}if(h.updateGui&&Ext.isObject(d.widget)){d.widget.setGui(k)}if(h.zoomToVisibleExtent){b.zoomToVisibleExtent()}if(h.hideMask){b.mask.hide()}if(h.callBack){h.callBack(d)}else{j.map=null;j.viewport.interpretationButton.disable()}};h={compare:false,updateGui:false,zoomToVisibleExtent:false,hideMask:false,callBack:null,load:function(k){j.olmap.mask.show();if(this.compare){e(k,true)}else{g(k)}},loadData:f,loadLegend:a};return h};GIS.core.getInstance=function(g){var d={},b={},e={},c={},f=[],a={};(function(){d.finals={url:{path_api:"/api/",path_module:"/dhis-web-mapping/",path_commons:"/dhis-web-commons-ajax-json/",organisationunitchildren_get:"getOrganisationUnitChildren.action",organisationunitgroup_getall:"organisationUnitGroups.json?paging=false&links=false",dataset_get:"dataSets.json?paging=false&links=false"},layer:{type_base:"base",type_vector:"vector",category_thematic:"thematic"},dimension:{data:{id:"data",value:"data",param:"dx",dimensionName:"dx",objectName:"dx"},category:{name:GIS.i18n.categories,dimensionName:"co",objectName:"co"},indicator:{id:"indicator",value:"indicators",param:"in",dimensionName:"dx",objectName:"in"},dataElement:{id:"dataElement",value:"dataElement",param:"de",dimensionName:"dx",objectName:"de"},operand:{id:"operand",value:"operand",param:"dc",dimensionName:"dx",objectName:"dc"},dataSet:{value:"dataSets",dimensionName:"dx",objectName:"ds"},period:{id:"period",value:"period",param:"pe",dimensionName:"pe",objectName:"pe"},organisationUnit:{id:"organisationUnit",value:"organisationUnit",param:"ou",dimensionName:"ou",objectName:"ou"},value:{id:"value",value:"value",param:"value",dimensionName:"value",objectName:"value"}},widget:{value:"value",legendtype_automatic:"automatic",legendtype_predefined:"predefined",symbolizer_color:"color",symbolizer_image:"image",loadtype_organisationunit:"organisationUnit",loadtype_data:"data",loadtype_legend:"legend"},openLayers:{point_classname:"OpenLayers.Geometry.Point"},mapfish:{classify_with_bounds:1,classify_by_equal_intervals:2,classify_by_quantils:3},root:{id:"root"}};d.layout={widget:{item_width:288,itemlabel_width:95,window_width:310},tool:{item_width:228,itemlabel_width:95,window_width:250},grid:{row_height:27}};d.period={periodTypes:[{id:"relativePeriods",name:"Relative"},{id:"Daily",name:"Daily"},{id:"Weekly",name:"Weekly"},{id:"Monthly",name:"Monthly"},{id:"BiMonthly",name:"BiMonthly"},{id:"Quarterly",name:"Quarterly"},{id:"SixMonthly",name:"SixMonthly"},{id:"Yearly",name:"Yearly"},{id:"FinancialOct",name:"FinancialOct"},{id:"FinancialJuly",name:"FinancialJuly"},{id:"FinancialApril",name:"FinancialApril"}],relativePeriods:[{id:"LAST_WEEK",name:GIS.i18n.last_week},{id:"LAST_MONTH",name:GIS.i18n.last_month},{id:"LAST_BIMONTH",name:GIS.i18n.last_bimonth},{id:"LAST_QUARTER",name:GIS.i18n.last_quarter},{id:"LAST_SIX_MONTH",name:GIS.i18n.last_sixmonth},{id:"LAST_FINANCIAL_YEAR",name:GIS.i18n.last_financial_year},{id:"THIS_YEAR",name:GIS.i18n.this_year},{id:"LAST_YEAR",name:GIS.i18n.last_year}]}}());(function(){b.map={};b.map.getVisibleVectorLayers=function(){var k=[];for(var j=0,h;j<a.olmap.layers.length;j++){h=a.olmap.layers[j];if(h.layerType===d.finals.layer.type_vector&&h.visibility&&h.features.length){k.push(h)}}return k};b.map.getExtendedBounds=function(k){var j=null;if(k.length){j=k[0].getDataExtent();if(k.length>1){for(var h=1;h<k.length;h++){j.extend(k[h].getDataExtent())}}}return j};b.map.zoomToVisibleExtent=function(i){var h=b.map.getExtendedBounds(b.map.getVisibleVectorLayers(i));if(h){i.zoomToExtent(h)}};b.map.getTransformedFeatureArray=function(l){var h=new OpenLayers.Projection("EPSG:4326"),j=new OpenLayers.Projection("EPSG:900913");for(var k=0;k<l.length;k++){l[k].geometry.transform(h,j)}return l};b.geojson={};b.geojson.decode=function(k){var h={};h.type="FeatureCollection";h.crs={type:"EPSG",properties:{code:"4326"}};h.features=[];for(var j=0;j<k.geojson.length;j++){h.features.push({geometry:{type:parseInt(k.geojson[j].ty)===1?"MultiPolygon":"Point",coordinates:k.geojson[j].co},properties:{id:k.geojson[j].uid,internalId:k.geojson[j].iid,name:k.geojson[j].na,hasCoordinatesDown:k.geojson[j].hcd,hasCoordinatesUp:k.geojson[j].hcu,level:k.geojson[j].le,grandParentParentGraph:k.geojson[j].gppg,grandParentId:k.geojson[j].gpuid,parentGraph:k.geojson[j].parentGraph,parentId:k.geojson[j].pi,parentName:k.geojson[j].pn}})}return h};b.gui={};b.gui.combo={};b.gui.combo.setQueryMode=function(h,k){for(var j=0;j<h.length;j++){h[j].queryMode=k}};b.object={};b.object.sortObjectsByString=function(i,h){h=h||"name";i.sort(function(k,j){var m=k[h].toLowerCase(),l=j[h].toLowerCase();if(m<l){return -1}if(m>l){return 1}return 0});return i};b.object.getLength=function(h){var j=0;for(var i in h){if(h.hasOwnProperty(i)){j++}}return j}}());a.init=g;a.conf=d;a.util=b;(function(){var h=a.conf.finals.dimension;e.layout={};e.response={};e.layout.Record=function(j){var i={};return function(){if(!Ext.isObject(j)){console.log("Record config is not an object: "+j);return}if(!Ext.isString(j.id)){alert("Record id is not text: "+j);return}i.id=j.id.replace(".","-");if(Ext.isString(j.name)){i.name=j.name}return Ext.clone(i)}()};e.layout.Dimension=function(i){var j={};return function(){if(!Ext.isObject(i)){console.log("Dimension config is not an object: "+i);return}if(!Ext.isString(i.dimension)){console.log("Dimension name is not text: "+i);return}if(i.dimension!==d.finals.dimension.category.objectName){var k=[];if(!Ext.isArray(i.items)){console.log("Dimension items is not an array: "+i);return}for(var l=0;l<i.items.length;l++){record=e.layout.Record(i.items[l]);if(record){k.push(record)}}i.items=k;if(!i.items.length){console.log("Dimension has no valid items: "+i);return}}j.dimension=i.dimension;j.items=i.items;return Ext.clone(j)}()};e.layout.Layout=function(j){var k={},i,l;i=function(p){var n=[];if(!(p&&Ext.isArray(p)&&p.length)){return}for(var m=0,o;m<p.length;m++){o=e.layout.Dimension(p[m]);if(o){n.push(o)}}p=n;return p.length?p:null};l=function(o){var q=[].concat(o.columns||[],o.rows||[],o.filters||[]),n,s,m;for(var p=0,r;p<q.length;p++){r=q[p];if(r.dimension===h.indicator.objectName||r.dimension===h.dataElement.objectName||r.dimension===h.operand.objectName||r.dimension===h.dataSet.objectName){n=r}else{if(r.dimension===h.period.objectName){s=r}else{if(r.dimension===h.organisationUnit.objectName){m=r}}}}o.columns=[n];o.rows=[m];o.filters=[s];return o};return function(){var s=[],r=[],u=d.finals.dimension,n=false,m=false,v=false;j=l(j);j.columns=i(j.columns);j.rows=i(j.rows);j.filters=i(j.filters);if(!(j.columns||j.rows||j.filters)){alert(a.el+": At least one dimension required");return}for(var p=0,q,t=Ext.Array.clean([].concat(j.columns,j.rows,j.filters));p<t.length;p++){q=t[p];if(q){if(Ext.isString(q.dimension)){r.push(q.dimension)}if(q.dimension===u.organisationUnit.objectName&&Ext.isArray(q.items)){for(var o=0;o<q.items.length;o++){if(q.items[o].id==="USER_ORGUNIT"){n=true}else{if(q.items[o].id==="USER_ORGUNIT_CHILDREN"){m=true}else{if(q.items[o].id==="USER_ORGUNIT_GRANDCHILDREN"){v=true}}}}}}}k.columns=j.columns;k.rows=j.rows;k.filters=j.filters;k.layer=Ext.isString(j.layer)&&!Ext.isEmpty(j.layer)?j.layer:"thematic1";k.classes=Ext.isNumber(j.classes)&&!Ext.isEmpty(j.classes)?j.classes:5;k.method=Ext.isNumber(j.method)&&!Ext.isEmpty(j.method)?j.method:2;k.colorLow=Ext.isString(j.colorLow)&&!Ext.isEmpty(j.colorLow)?j.colorLow:"ff0000";k.colorHigh=Ext.isString(j.colorHigh)&&!Ext.isEmpty(j.colorHigh)?j.colorHigh:"00ff00";k.radiusLow=Ext.isNumber(j.radiusLow)&&!Ext.isEmpty(j.radiusLow)?j.radiusLow:5;k.radiusHigh=Ext.isNumber(j.radiusHigh)&&!Ext.isEmpty(j.radiusHigh)?j.radiusHigh:15;k.opacity=Ext.isNumber(j.opacity)&&!Ext.isEmpty(j.opacity)?j.opacity:0.8;k.userOrganisationUnit=n;k.userOrganisationUnitChildren=m;k.userOrganisationUnitGrandChildren=v;k.parentGraphMap=Ext.isObject(j.parentGraphMap)?j.parentGraphMap:null;k.legendSet=j.legendSet;k.labels=j.labels;k.organisationUnitGroupSet=j.organisationUnitGroupSet;k.areaRadius=j.areaRadius;return Ext.clone(k)}()};e.response.Header=function(i){var j={};return function(){if(!Ext.isObject(i)){console.log("Header is not an object: "+i);return}if(!Ext.isString(i.name)){console.log("Header name is not text: "+i);return}if(!Ext.isBoolean(i.meta)){console.log("Header meta is not boolean: "+i);return}j.name=i.name;j.meta=i.meta;return Ext.clone(j)}()};e.response.Response=function(j){var i={};return function(){var l=[];if(!(j&&Ext.isObject(j))){alert("Data response invalid");return false}if(!(j.headers&&Ext.isArray(j.headers))){alert("Data response invalid");return false}for(var k=0,m;k<j.headers.length;k++){m=e.response.Header(j.headers[k]);if(m){l.push(m)}}j.headers=l;if(!j.headers.length){alert("No valid response headers");return}if(!(Ext.isArray(j.rows)&&j.rows.length>0)){alert("No values found");return false}if(j.headers.length!==j.rows[0].length){alert("Data invalid");return false}i.headers=j.headers;i.metaData=j.metaData;i.width=j.width;i.height=j.height;i.rows=j.rows;return i}()}}());(function(){c.organisationUnitLevels=GIS.core.OrganisationUnitLevelStore(a)}());a.api=e;a.store=c;a.olmap=GIS.core.getOLMap(a);a.layer=GIS.core.getLayers(a);a.thematicLayers=[a.layer.thematic1,a.layer.thematic2,a.layer.thematic3,a.layer.thematic4];if(window.google){f.push(a.layer.googleStreets,a.layer.googleHybrid)}f.push(a.layer.openStreetMap,a.layer.thematic4,a.layer.thematic3,a.layer.thematic2,a.layer.thematic1,a.layer.boundary,a.layer.facility);a.olmap.addLayers(f);GIS.core.instances.push(a);return a};(function(){window.mapfish={_scriptName:"MapFish.js",_getScriptLocation:function(){if(window.gMfLocation){return window.gMfLocation}var s="";var t=mapfish._scriptName;var h=document.getElementsByTagName("script");for(var r=0;r<h.length;r++){var u=h[r].getAttribute("src");if(u){var q=u.lastIndexOf(t);if((q>-1)&&(q+t.length==u.length)){s=u.slice(0,-t.length);break}}}return s}};var l=new Array("core/Color.js","core/GeoStat.js","core/GeoStat/Boundary.js","core/GeoStat/Thematic1.js","core/GeoStat/Thematic2.js","core/GeoStat/Facility.js","core/GeoStat/Symbol.js","core/Util.js");var c="";var o=mapfish._getScriptLocation();for(var d=0;d<l.length;d++){if(/MSIE/.test(navigator.userAgent)||/Safari/.test(navigator.userAgent)){var g="<script src='"+o+l[d]+"'><\/script>";c+=g}else{var p=document.createElement("script");p.src=o+l[d];var e=document.getElementsByTagName("head").length?document.getElementsByTagName("head")[0]:document.body;e.appendChild(p)}}if(c){}mapfish.Color=OpenLayers.Class({getColorRgb:function(){}});mapfish.ColorRgb=OpenLayers.Class(mapfish.Color,{redLevel:null,greenLevel:null,blueLevel:null,initialize:function(q,i,h){this.redLevel=q;this.greenLevel=i;this.blueLevel=h},equals:function(h){return h.redLevel==this.redLevel&&h.greenLevel==this.greenLevel&&h.blueLevel==this.blueLevel},getColorRgb:function(){return this},getRgbArray:function(){return[this.redLevel,this.greenLevel,this.blueLevel]},hex2rgbArray:function(h){if(h.charAt(0)=="#"){h=h.substr(1)}var q=[parseInt(h.substring(0,2),16),parseInt(h.substring(2,4),16),parseInt(h.substring(4,6),16)];for(var r=0;r<q.length;r++){if(q[r]<0||q[r]>255){OpenLayers.Console.error("Invalid rgb hex color string: rgbHexString")}}return q},setFromHex:function(h){var i=this.hex2rgbArray(h);this.redLevel=i[0];this.greenLevel=i[1];this.blueLevel=i[2]},setFromRgb:function(i){var h=dojo.colorFromString(i);this.redLevel=h.r;this.greenLevel=h.g;this.blueLevel=h.b},toHexString:function(){var q=this.toHex(this.redLevel);var i=this.toHex(this.greenLevel);var h=this.toHex(this.blueLevel);return"#"+q+i+h},toHex:function(t){var q="0123456789ABCDEF";if(t<0||t>255){var s="Invalid decimal value for color level";OpenLayers.Console.error(s)}var r=Math.floor(t/16);var h=t%16;return q.charAt(r)+q.charAt(h)},CLASS_NAME:"mapfish.ColorRgb"});mapfish.ColorRgb.getColorsArrayByRgbInterpolation=function(x,s,u){var y=[];var q=x.getColorRgb();var h=s.getColorRgb();var w=q.getRgbArray();var v=h.getRgbArray();if(u==1){return[q]}for(var t=0;t<u;t++){var r=[];r[0]=w[0]+t*(v[0]-w[0])/(u-1);r[1]=w[1]+t*(v[1]-w[1])/(u-1);r[2]=w[2]+t*(v[2]-w[2])/(u-1);y[t]=new mapfish.ColorRgb(parseInt(r[0]),parseInt(r[1]),parseInt(r[2]))}return y};mapfish.Util={};mapfish.Util.sum=function(r){for(var h=0,q=0;h<r.length;q+=r[h++]){}return q};mapfish.Util.max=function(h){return Math.max.apply({},h)};mapfish.Util.min=function(h){return Math.min.apply({},h)};mapfish.Util.getIconUrl=function(i,h){if(!h.layer){OpenLayers.Console.warn("Missing required layer option in mapfish.Util.getIconUrl");return""}if(!h.rule){h.rule=h.layer}if(i.indexOf("?")<0){i+="?"}else{if(i.lastIndexOf("&")!=(i.length-1)){if(i.indexOf("?")!=(i.length-1)){i+="&"}}}var h=OpenLayers.Util.extend({layer:"",rule:"",service:"WMS",version:"1.1.1",request:"GetLegendGraphic",format:"image/png",width:16,height:16},h);h=OpenLayers.Util.upperCaseObject(h);return i+OpenLayers.Util.getParameterString(h)};mapfish.Util.arrayEqual=function(q,h){if(q==null||h==null){return false}if(typeof(q)!="object"||typeof(h)!="object"){return false}if(q.length!=h.length){return false}for(var r=0;r<q.length;r++){if(typeof(q[r])!=typeof(h[r])){return false}if(q[r]!=h[r]){return false}}return true};mapfish.Util.isIE7=function(){var h=navigator.userAgent.toLowerCase();return h.indexOf("msie 7")>-1};mapfish.Util.relativeToAbsoluteURL=function(q){if(/^\w+:/.test(q)||!q){return q}var i=location.protocol+"//"+location.host;if(q.indexOf("/")==0){return i+q}var r=location.pathname.replace(/\/[^\/]*$/,"");return i+r+"/"+q};mapfish.Util.fixArray=function(h){if(h==""||h==null){return[]}else{if(h instanceof Array){return h}else{return h.split(",")}}};mapfish.GeoStat=OpenLayers.Class({layer:null,format:null,url:null,requestSuccess:function(h){},requestFailure:function(h){},indicator:null,defaultSymbolizer:{},legendDiv:null,initialize:function(q,h){this.map=q;this.addOptions(h);if(!this.layer){var i=new OpenLayers.Layer.Vector("geostat",{displayInLayerSwitcher:false,visibility:false});q.addLayer(i);this.layer=i}this.setUrl(this.url);this.legendDiv=Ext.get(h.legendDiv)},setUrl:function(h){this.url=h;if(this.url){OpenLayers.Request.GET({url:this.url,scope:this,success:this.requestSuccess,failure:this.requestFailure})}},getColors:function(h,q){var r=new mapfish.ColorRgb(),i=new mapfish.ColorRgb();r.setFromHex(h);i.setFromHex(q);return[r,i]},addOptions:function(h){if(h){if(!this.options){this.options={}}OpenLayers.Util.extend(this.options,h);OpenLayers.Util.extend(this,h)}},extendStyle:function(r,q,h){var i=this.layer.styleMap.styles["default"];if(r){i.rules=r}if(q){i.setDefaultStyle(OpenLayers.Util.applyDefaults(q,i.defaultStyle))}if(h){if(!i.context){i.context={}}OpenLayers.Util.extend(i.context,h)}},applyClassification:function(h){this.layer.renderer.clear();this.layer.redraw();this.updateLegend();this.layer.setVisibility(true)},showDetails:function(h){},hideDetails:function(h){},CLASS_NAME:"mapfish.GeoStat"});mapfish.GeoStat.Distribution=OpenLayers.Class({labelGenerator:function(i,r,s){var h=parseFloat(i.lowerBound).toFixed(1),q=parseFloat(i.upperBound).toFixed(1);return h+" - "+q+"&nbsp;&nbsp;("+i.nbVal+")"},values:null,nbVal:null,minVal:null,maxVal:null,initialize:function(h,i){OpenLayers.Util.extend(this,i);this.values=h;this.nbVal=h.length;this.minVal=this.nbVal?mapfish.Util.min(this.values):0;this.maxVal=this.nbVal?mapfish.Util.max(this.values):0},classifyWithBounds:function(h){var y=[];var v=[];var x=[];for(var u=0;u<this.values.length;u++){x.push(this.values[u])}x.sort(function(z,i){return z-i});var w=h.length-1;for(var t=0;t<w;t++){v[t]=0}for(var s=0;s<w-1;s){if(x[0]<h[s+1]){v[s]=v[s]+1;x.shift()}else{s++}}v[w-1]=this.nbVal-mapfish.Util.sum(v);for(var r=0;r<w;r++){y[r]=new mapfish.GeoStat.Bin(v[r],h[r],h[r+1],r==(w-1));var q=this.labelGenerator||this.defaultLabelGenerator;y[r].label=q(y[r],r,w)}return new mapfish.GeoStat.Classification(y)},classifyByEqIntervals:function(r){var q=[];for(var h=0;h<=r;h++){q[h]=this.minVal+h*(this.maxVal-this.minVal)/r}return this.classifyWithBounds(q)},classifyByQuantils:function(t){var h=this.values;h.sort(function(v,u){return v-u});var s=Math.round(this.values.length/t);var r=[];var q=(s===0)?0:s;if(h.length>0){r[0]=h[0];for(d=1;d<t;d++){r[d]=h[q];q+=s}r.push(h[h.length-1])}for(var i=0;i<r.length;i++){r[i]=parseFloat(r[i])}return this.classifyWithBounds(r)},sturgesRule:function(){return Math.floor(1+3.3*Math.log(this.nbVal,10))},classify:function(r,q,h){var i=null;if(!q){q=this.sturgesRule()}switch(parseFloat(r)){case mapfish.GeoStat.Distribution.CLASSIFY_WITH_BOUNDS:i=this.classifyWithBounds(h);break;case mapfish.GeoStat.Distribution.CLASSIFY_BY_EQUAL_INTERVALS:i=this.classifyByEqIntervals(q);break;case mapfish.GeoStat.Distribution.CLASSIFY_BY_QUANTILS:i=this.classifyByQuantils(q);break;default:OpenLayers.Console.error("Unsupported or invalid classification method")}return i},CLASS_NAME:"mapfish.GeoStat.Distribution"});mapfish.GeoStat.Distribution.CLASSIFY_WITH_BOUNDS=1;mapfish.GeoStat.Distribution.CLASSIFY_BY_EQUAL_INTERVALS=2;mapfish.GeoStat.Distribution.CLASSIFY_BY_QUANTILS=3;mapfish.GeoStat.Bin=OpenLayers.Class({label:null,nbVal:null,lowerBound:null,upperBound:null,isLast:false,initialize:function(q,r,i,h){this.nbVal=q;this.lowerBound=r;this.upperBound=i;this.isLast=h},CLASS_NAME:"mapfish.GeoStat.Bin"});mapfish.GeoStat.Classification=OpenLayers.Class({bins:[],initialize:function(h){this.bins=h},getBoundsArray:function(){var q=[];for(var h=0;h<this.bins.length;h++){q.push(this.bins[h].lowerBound)}if(this.bins.length>0){q.push(this.bins[this.bins.length-1].upperBound)}return q},CLASS_NAME:"mapfish.GeoStat.Classification"});mapfish.GeoStat.Boundary=OpenLayers.Class(mapfish.GeoStat,{colors:[new mapfish.ColorRgb(120,120,0),new mapfish.ColorRgb(255,0,0)],method:mapfish.GeoStat.Distribution.CLASSIFY_BY_QUANTILS,numClasses:5,minSize:3,maxSize:20,minVal:null,maxVal:null,defaultSymbolizer:{fillOpacity:1},classification:null,colorInterpolation:null,gis:null,view:null,featureStore:Ext.create("Ext.data.Store",{fields:["id","name"],features:[],loadFeatures:function(q){if(q&&q.length){var r=[];for(var h=0;h<q.length;h++){r.push([q[h].attributes.id,q[h].attributes.name])}this.loadData(r);this.sortStore();this.features=q}else{this.removeAll()}},sortStore:function(){this.sort("name","ASC")}}),initialize:function(i,h){mapfish.GeoStat.prototype.initialize.apply(this,arguments)},getLoader:function(){return GIS.core.LayerLoaderBoundary(this.gis,this.layer)},reset:function(){this.layer.destroyFeatures();if(this.layer.widget){this.layer.widget.reset()}},extendView:function(h,i){h=h||this.view;h.organisationUnitLevel=i.organisationUnitLevel||h.organisationUnitLevel;h.parentOrganisationUnit=i.parentOrganisationUnit||h.parentOrganisationUnit;h.parentLevel=i.parentLevel||h.parentLevel;h.parentGraph=i.parentGraph||h.parentGraph;h.opacity=i.opacity||h.opacity;return h},getLegendConfig:function(){return},getImageLegendConfig:function(){return},updateOptions:function(i){var h=OpenLayers.Util.extend({},this.options);this.addOptions(i);if(i){this.setClassification()}},createColorInterpolation:function(){var h=this.classification.bins.length;this.colorInterpolation=mapfish.ColorRgb.getColorsArrayByRgbInterpolation(this.colors[0],this.colors[1],h)},setClassification:function(){var q=[];for(var r=0;r<this.layer.features.length;r++){q.push(this.layer.features[r].attributes[this.indicator])}var h={labelGenerator:this.options.labelGenerator};var s=new mapfish.GeoStat.Distribution(q,h);this.minVal=s.minVal;this.maxVal=s.maxVal;this.classification=s.classify(this.method,this.numClasses,null);this.createColorInterpolation()},applyClassification:function(h){this.updateOptions(h);var u=OpenLayers.Function.bind(function(v){var w=v.attributes[this.indicator];var i=(w-this.minVal)/(this.maxVal-this.minVal)*(this.maxSize-this.minSize)+this.minSize;return i||this.minSize},this);this.extendStyle(null,{pointRadius:"${calculateRadius}"},{calculateRadius:u});var s=this.classification.getBoundsArray();var t=new Array(s.length-1);for(var q=0;q<s.length-1;q++){var r=new OpenLayers.Rule({symbolizer:{fillColor:this.colorInterpolation[q].toHexString()},filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN,property:this.indicator,lowerBoundary:s[q],upperBoundary:s[q+1]})});t[q]=r}this.extendStyle(t);mapfish.GeoStat.prototype.applyClassification.apply(this,arguments)},updateLegend:function(){},CLASS_NAME:"mapfish.GeoStat.Boundary"});mapfish.GeoStat.Facility=OpenLayers.Class(mapfish.GeoStat,{classification:null,gis:null,view:null,featureStore:Ext.create("Ext.data.Store",{fields:["id","name"],features:[],loadFeatures:function(q){if(q&&q.length){var r=[];for(var h=0;h<q.length;h++){r.push([q[h].attributes.id,q[h].attributes.name])}this.loadData(r);this.sortStore();this.features=q}else{this.removeAll()}},sortStore:function(){this.sort("name","ASC")}}),initialize:function(i,h){mapfish.GeoStat.prototype.initialize.apply(this,arguments)},getLoader:function(){return GIS.core.LayerLoaderFacility(this.gis,this.layer)},decode:function(u){var s,t,h,q={type:"FeatureCollection",crs:{type:"EPSG",properties:{code:"4326"}},features:[]};for(var r=0;r<u.geojson.length;r++){h=u.geojson[r];s={geometry:{type:parseInt(h.ty)===1?"MultiPolygon":"Point",coordinates:h.co},properties:{id:h.uid,internalId:h.iid,name:h.na}};s.properties=Ext.Object.merge(s.properties,h.groupSets);q.features.push(s)}return q},reset:function(){this.layer.destroyFeatures();this.layer.legendPanel.update("");this.layer.legendPanel.collapse();if(this.layer.widget){this.layer.widget.reset()}},extendView:function(h,i){h=h||this.view;h.organisationUnitGroupSet=i.organisationUnitGroupSet||h.organisationUnitGroupSet;h.organisationUnitLevel=i.organisationUnitLevel||h.organisationUnitLevel;h.parentOrganisationUnit=i.parentOrganisationUnit||h.parentOrganisationUnit;h.parentLevel=i.parentLevel||h.parentLevel;h.parentGraph=i.parentGraph||h.parentGraph;h.opacity=i.opacity||h.opacity;return h},updateOptions:function(h){this.addOptions(h)},applyClassification:function(q){this.updateOptions(q);var h=this.gis.store.groupsByGroupSet.data.items;var t=new Array(h.length);for(var r=0;r<h.length;r++){var s=new OpenLayers.Rule({symbolizer:{pointRadius:8,externalGraphic:"../../images/orgunitgroup/"+h[r].data.symbol},filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:this.indicator,value:h[r].data.name})});t[r]=s}this.extendStyle(t);mapfish.GeoStat.prototype.applyClassification.apply(this,arguments)},updateLegend:function(){var r=document.createElement("div"),s=document.createElement("div"),h=this.gis.store.groupsByGroupSet.data.items;for(var q=0;q<h.length;q++){s=document.createElement("div");s.style.backgroundImage="url(../../images/orgunitgroup/"+h[q].data.symbol+")";s.style.backgroundRepeat="no-repeat";s.style.width="21px";s.style.height="16px";s.style.marginBottom="2px";s.style.cssFloat="left";r.appendChild(s);s=document.createElement("div");s.innerHTML=h[q].data.name;s.style.height="16px";s.style.lineHeight="17px";r.appendChild(s);s=document.createElement("div");s.style.clear="left";r.appendChild(s)}this.layer.legendPanel.update(r.outerHTML)},CLASS_NAME:"mapfish.GeoStat.Facility"});mapfish.GeoStat.createThematic=function(h){mapfish.GeoStat[h]=OpenLayers.Class(mapfish.GeoStat,{colors:[new mapfish.ColorRgb(120,120,0),new mapfish.ColorRgb(255,0,0)],method:mapfish.GeoStat.Distribution.CLASSIFY_BY_QUANTILS,numClasses:5,bounds:null,minSize:3,maxSize:20,minVal:null,maxVal:null,defaultSymbolizer:{fillOpacity:1},classification:null,colorInterpolation:null,gis:null,view:null,featureStore:Ext.create("Ext.data.Store",{fields:["id","name"],features:[],loadFeatures:function(r){if(r&&r.length){var s=[];for(var q=0;q<r.length;q++){s.push([r[q].attributes.id,r[q].attributes.name])}this.loadData(s);this.sortStore();this.features=r}else{this.removeAll()}},sortStore:function(){this.sort("name","ASC")}}),initialize:function(q,i){mapfish.GeoStat.prototype.initialize.apply(this,arguments)},getLoader:function(){return GIS.core.LayerLoaderThematic(this.gis,this.layer)},reset:function(){this.layer.destroyFeatures();this.featureStore.loadFeatures(this.layer.features.slice(0));this.layer.legendPanel.update("");this.layer.legendPanel.collapse();if(this.layer.widget){this.layer.widget.reset()}},extendView:function(i,q){i=i||this.view;i.valueType=q.valueType||i.valueType;i.indicatorGroup=q.indicatorGroup||i.indicatorGroup;i.indicator=q.indicator||i.indicator;i.dataElementGroup=q.dataElementGroup||i.dataElementGroup;i.dataElement=q.dataElement||i.dataElement;i.periodType=q.periodType||i.periodType;i.period=q.period||i.period;i.legendType=q.legendType||i.legendType;i.legendSet=q.legendSet||i.legendSet;i.classes=q.classes||i.classes;i.method=q.method||i.method;i.colorLow=q.colorLow||i.colorLow;i.colorHigh=q.colorHigh||i.colorHigh;i.radiusLow=q.radiusLow||i.radiusLow;i.radiusHigh=q.radiusHigh||i.radiusHigh;i.organisationUnitLevel=q.organisationUnitLevel||i.organisationUnitLevel;i.parentOrganisationUnit=q.parentOrganisationUnit||i.parentOrganisationUnit;i.parentLevel=q.parentLevel||i.parentLevel;i.parentGraph=q.parentGraph||i.parentGraph;i.opacity=q.opacity||i.opacity;return i},getImageLegendConfig:function(){var t=this.classification.bins,r=this.colorInterpolation,q=[];for(var s=0;s<t.length;s++){q.push({color:r[s].toHexString(),label:t[s].lowerBound.toFixed(1)+" - "+t[s].upperBound.toFixed(1)+" ("+t[s].nbVal+")"})}return q},updateOptions:function(q){var i=OpenLayers.Util.extend({},this.options);this.addOptions(q);if(q){this.setClassification()}},createColorInterpolation:function(){var i=this.classification.bins.length;if(!this.view.legendSet){this.colorInterpolation=mapfish.ColorRgb.getColorsArrayByRgbInterpolation(this.colors[0],this.colors[1],i)}},setClassification:function(){var r=[];for(var s=0;s<this.layer.features.length;s++){r.push(this.layer.features[s].attributes[this.indicator])}var q={labelGenerator:this.options.labelGenerator};var t=new mapfish.GeoStat.Distribution(r,q);this.minVal=t.minVal;this.maxVal=t.maxVal;if(this.view.legendType===this.gis.conf.finals.widget.legendtype_predefined){if(this.bounds[0]>this.minVal){this.bounds.unshift(this.minVal);this.colorInterpolation.unshift(new mapfish.ColorRgb(240,240,240))}if(this.bounds[this.bounds.length-1]<this.maxVal){this.bounds.push(this.maxVal);this.colorInterpolation.push(new mapfish.ColorRgb(240,240,240))}}this.classification=t.classify(this.method,this.numClasses,this.bounds);this.createColorInterpolation()},applyClassification:function(q,s){this.updateOptions(q,s);var w=OpenLayers.Function.bind(function(x){var y=x.attributes[this.indicator];var i=(y-this.minVal)/(this.maxVal-this.minVal)*(this.maxSize-this.minSize)+this.minSize;return i||this.minSize},this);this.extendStyle(null,{pointRadius:"${calculateRadius}"},{calculateRadius:w});var u=this.classification.getBoundsArray();var v=new Array(u.length-1);for(var r=0;r<u.length-1;r++){var t=new OpenLayers.Rule({symbolizer:{fillColor:this.colorInterpolation[r].toHexString()},filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN,property:this.indicator,lowerBoundary:u[r],upperBoundary:u[r+1]})});v[r]=t}this.extendStyle(v);mapfish.GeoStat.prototype.applyClassification.apply(this,arguments)},updateLegend:function(){var r=document.createElement("div"),t,s;t=document.createElement("div");t.style.height="14px";t.style.overflow="hidden";t.title=this.view.columns[0].items[0].name;t.innerHTML=this.view.columns[0].items[0].name;r.appendChild(t);t=document.createElement("div");t.style.clear="left";r.appendChild(t);t=document.createElement("div");t.style.height="14px";t.style.overflow="hidden";t.title=this.view.filters[0].items[0].name;t.innerHTML=this.view.filters[0].items[0].name;r.appendChild(t);t=document.createElement("div");t.style.clear="left";r.appendChild(t);t=document.createElement("div");t.style.width="1px";t.style.height="5px";r.appendChild(t);if(this.view.legendSet){for(var q=0;q<this.classification.bins.length;q++){t=document.createElement("div");t.style.backgroundColor=this.colorInterpolation[q].toHexString();t.style.width="30px";t.style.height=this.view.legendSet.names[q]?"25px":"20px";t.style.cssFloat="left";t.style.marginRight="8px";r.appendChild(t);t=document.createElement("div");t.style.lineHeight=this.view.legendSet.names[q]?"12px":"7px";t.innerHTML='<b style="color:#222; font-size:10px !important">'+(this.view.legendSet.names[q]||"")+"</b><br/>"+this.classification.bins[q].label;r.appendChild(t);t=document.createElement("div");t.style.clear="left";r.appendChild(t)}}else{for(var q=0;q<this.classification.bins.length;q++){t=document.createElement("div");t.style.backgroundColor=this.colorInterpolation[q].toHexString();t.style.width="30px";t.style.height="15px";t.style.cssFloat="left";t.style.marginRight="8px";r.appendChild(t);t=document.createElement("div");t.innerHTML=this.classification.bins[q].label;r.appendChild(t);t=document.createElement("div");t.style.clear="left";r.appendChild(t)}}this.layer.legendPanel.update(r.outerHTML)},CLASS_NAME:"mapfish.GeoStat."+h})};mapfish.GeoStat.createThematic("Thematic1");mapfish.GeoStat.createThematic("Thematic2");mapfish.GeoStat.createThematic("Thematic3");mapfish.GeoStat.createThematic("Thematic4");var n={user:{}},f=[],a=false,k=false,m,b,j;GIS.i18n={facility_layer_legend:"Facility layer legend",thematic_layer_1_legend:"Thematic layer 1 legend",thematic_layer_2_legend:"Thematic layer 2 legend",thematic_layer_3_legend:"Thematic layer 3 legend",thematic_layer_4_legend:"Thematic layer 4 legend",measure_distance:"Measure distance"};GIS.plugin={};m=function(h){var u=false,t=[],s=0,r;r=function(){if(++s===t.length){k=true;for(var v=0;v<f.length;v++){j(f[v])}f=[]}};t.push({url:h+"/api/system/context.jsonp",success:function(i){n.contextPath=i.contextPath;r()}});t.push({url:h+"/api/organisationUnits.jsonp?userOnly=true&viewClass=detailed&links=false",success:function(w){var v=w.organisationUnits||[];if(v.length){var i=v[0];if(i.id){n.user={ou:i.id};n.user.ouc=i.children?Ext.Array.pluck(i.children,"id"):null}}else{console.log("User is not assigned to any organisation units")}r()}});t.push({url:h+"/api/mapLegendSets.jsonp?viewClass=detailed&links=false&paging=false",success:function(i){n.legendSets=Ext.isArray(i.mapLegendSets)?i.mapLegendSets:[];r()}});t.push({url:h+"/api/dimensions.jsonp?links=false&paging=false",success:function(i){n.dimensions=Ext.isArray(i.dimensions)?i.dimensions:[];r()}});for(var q=0;q<t.length;q++){Ext.data.JsonP.request(t[q])}};b=function(){var h=".gis-plugin, .gis-plugin * { font-family: arial, sans-serif, liberation sans, consolas; } \n";h+=".x-panel-body { font-size: 11px; } \n";h+=".x-panel-header { height: 30px; padding: 7px 4px 4px 7px; border: 0 none; } \n";h+=".gis-container-default .x-window-body { padding: 5px; background: #fff; } \n";h+=".olControlPanel { position: absolute; top: 0; right: 0; border: 0 none; } \n";h+='.olControlButtonItemActive { background: #556; color: #fff; width: 24px; height: 24px; opacity: 0.75; filter: alpha(opacity=75); -ms-filter: "alpha(opacity=75)"; cursor: pointer; cursor: hand; text-align: center; font-size: 21px !important; text-shadow: 0 0 1px #ddd; } \n';h+=".olControlPanel.zoomIn { right: 72px; } \n";h+=".olControlPanel.zoomIn .olControlButtonItemActive { border-bottom-left-radius: 2px; } \n";h+=".olControlPanel.zoomOut { right: 48px; } \n";h+=".olControlPanel.zoomVisible { right: 24px; } \n";h+=".olControlPermalink { display: none !important; } \n";h+='.olControlMousePosition { background: #fff !important; opacity: 0.8 !important; filter: alpha(opacity=80) !important; -ms-filter: "alpha(opacity=80)" !important; right: 0 !important; bottom: 0 !important; border-top-left-radius: 2px !important; padding: 2px 2px 2px 5px !important; color: #000 !important; -webkit-text-stroke-width: 0.2px; -webkit-text-stroke-color: #555; } \n';h+=".olControlMousePosition * { font-size: 10px !important; } \n";h+=".text-mouseposition-lonlat { color: #555; } \n";h+=".olLayerGoogleCopyright, .olLayerGoogleV3.olLayerGooglePoweredBy { display: none; } \n";h+='#google-logo { background: url("'+n.contextPath+'/dhis-web-mapping/app/images/google-logo.png") no-repeat; width: 40px; height: 13px; margin-left: 6px; display: inline-block; vertical-align: bottom; cursor: pointer; cursor: hand; } \n';h+=".olControlScaleLine { left: 5px !important; bottom: 5px !important; } \n";h+=".olControlScaleLineBottom { display: none; } \n";h+=".olControlScaleLineTop { font-weight: bold; } \n";h+=".x-mask-msg { padding: 0; border: 0 none; background-image: none; background-color: transparent; } \n";h+=".x-mask-msg div { background-position: 11px center; } \n";h+=".x-mask-msg .x-mask-loading { border: 0 none; background-color: #000; color: #fff; border-radius: 2px; padding: 12px 14px 12px 30px; opacity: 0.65; } \n";h+=".gis-window-widget-feature { padding: 0; border: 0 none; border-radius: 0; background: transparent; box-shadow: none; } \n";h+=".gis-window-widget-feature .x-window-body-default { border: 0 none; background: transparent; } \n";h+='.gis-window-widget-feature .x-window-body-default .x-panel-body-default { border: 0 none; background: #556; opacity: 0.92; filter: alpha(opacity=92); -ms-filter: "alpha(opacity=92)"; padding: 5px 8px 5px 8px; border-bottom-left-radius: 2px; border-bottom-right-radius: 2px; color: #fff; font-weight: bold; letter-spacing: 1px; } \n';h+=".x-menu-body { border:1px solid #bbb; border-radius: 2px; padding: 0; background-color: #fff !important; } \n";h+=".x-menu-item-active .x-menu-item-link {	border-radius: 0; border-color: #e1e1e1; background-color: #e1e1e1; background-image: none; } \n";h+=".x-menu-item-link { padding: 4px 5px 4px 26px; } \n";h+=".x-menu-item-text { color: #111; } \n";h+=".disabled { opacity: 0.4; cursor: default !important; } \n";h+=".el-opacity-1 { opacity: 1 !important; } \n";h+=".el-border-0, .el-border-0 .x-panel-body { border: 0 none !important; } \n";h+=".el-fontsize-10 { font-size: 10px !important; } \n";h+=".gis-grid-row-icon-disabled * { cursor: default !important; } \n";h+=".gis-toolbar-btn-menu { margin-top: 4px; } \n";h+=".gis-toolbar-btn-menu .x-panel-body-default { border-radius: 2px; border-color: #999; } \n";h+=".gis-grid .link, .gis-grid .link * { cursor: pointer; cursor: hand; color: blue; text-decoration: underline; } \n";h+=".gis-menu-item-icon-drill, .gis-menu-item-icon-float { left: 6px; } \n";h+=".gis-menu-item-first.x-menu-item-active .x-menu-item-link {	border-radius: 0; border-top-left-radius: 2px; border-top-right-radius: 2px; } \n";h+=".gis-menu-item-last.x-menu-item-active .x-menu-item-link { border-radius: 0; border-bottom-left-radius: 2px; border-bottom-right-radius: 2px; } \n";h+='.gis-menu-item-icon-drill { \n background: url("'+n.contextPath+'/dhis-web-mapping/app/images/drill_16.png") no-repeat; } \n';h+='.gis-menu-item-icon-float { background: url("'+n.contextPath+'/dhis-web-mapping/app/images/float_16.png") no-repeat; } \n';h+=".x-color-picker a { padding: 0; } \n";h+=".x-color-picker em span { width: 14px; height: 14px; } \n";Ext.util.CSS.createStyleSheet(h)};j=function(r){var t,i,s,h,q;t=function(){if(!Ext.isString(r.url)){alert("Invalid url ("+r.el+")");return}if(r.url.split("").pop()==="/"){r.url=r.url.substr(0,r.url.length-1)}if(!Ext.isString(r.el)){alert("Invalid html element id ("+r.el+")");return}r.id=r.id||r.uid;if(r.id&&!Ext.isString(r.id)){alert("Invalid map id ("+r.el+")");return}return true};i=function(){var u,x,w,v=Ext.get(q.el);u=Ext.create("Ext.panel.Panel",{renderTo:v,width:v.getWidth(),height:v.getHeight(),cls:"gis-plugin",layout:{type:"hbox",align:"stretch"},items:[{xtype:"gx_mappanel",map:q.olmap,bodyStyle:"border:0 none",width:v.getWidth()-(q.map.hideLegend?0:200),height:v.getHeight(),listeners:{added:function(){w=this}}},{xtype:"panel",layout:"anchor",bodyStyle:"border-top:0 none; border-bottom:0 none",width:q.map.hideLegend?0:200,preventHeader:true,defaults:{bodyStyle:"padding: 6px; border: 0 none",collapsible:true,collapsed:true,animCollapse:false},items:[{title:GIS.i18n.thematic_layer_1_legend,bodyStyle:"padding:3px 0 4px 5px; border-width:1px 0 1px 0; border-color:#d0d0d0;",listeners:{added:function(){q.layer.thematic1.legendPanel=this}}},{title:GIS.i18n.thematic_layer_2_legend,bodyStyle:"padding:3px 0 4px 5px; border-width:1px 0 1px 0; border-color:#d0d0d0;",listeners:{added:function(){q.layer.thematic2.legendPanel=this}}},{title:GIS.i18n.thematic_layer_3_legend,bodyStyle:"padding:3px 0 4px 5px; border-width:1px 0 1px 0; border-color:#d0d0d0;",listeners:{added:function(){q.layer.thematic3.legendPanel=this}}},{title:GIS.i18n.thematic_layer_4_legend,bodyStyle:"padding:3px 0 4px 5px; border-width:1px 0 1px 0; border-color:#d0d0d0;",listeners:{added:function(){q.layer.thematic4.legendPanel=this}}},{title:GIS.i18n.facility_layer_legend,bodyStyle:"padding:3px 0 4px 5px; border-width:1px 0 1px 0; border-color:#d0d0d0;",listeners:{added:function(){q.layer.facility.legendPanel=this}}}],listeners:{added:function(){x=this}}}],listeners:{afterrender:function(){s()}}});u.centerRegion=w;u.eastRegion=x;return u};s=function(v){var u=Ext.query(".zoomInButton").length;for(var w=0;w<u;w++){Ext.query(".zoomInButton")[w].innerHTML='<img src="'+q.init.contextPath+'/dhis-web-mapping/app/images/zoomin_24.png" />';Ext.query(".zoomOutButton")[w].innerHTML='<img src="'+q.init.contextPath+'/dhis-web-mapping/app/images/zoomout_24.png" />';Ext.query(".zoomVisibleButton")[w].innerHTML='<img src="'+q.init.contextPath+'/dhis-web-mapping/app/images/zoomvisible_24.png" />';Ext.query(".measureButton")[w].innerHTML='<img src="'+q.init.contextPath+'/dhis-web-mapping/app/images/measure_24.png" />'}if(Ext.isDefined(q.map.baseLayer)){var x=Ext.isString(q.map.baseLayer)?q.map.baseLayer.split(" ").join("").toLowerCase():q.map.baseLayer;if(!x||x==="none"||x==="off"){q.layer.googleStreets.setVisibility(false)}else{if(x==="gh"||x==="googlehybrid"){q.olmap.setBaseLayer(q.layer.googleHybrid)}else{if(x==="osm"||x==="openstreetmap"){q.olmap.setBaseLayer(q.layer.openStreetMap)}}}}};h=function(){if(!t()){return}b();q=GIS.core.getInstance(n);q.el=r.el;GIS.core.createSelectHandlers(q,q.layer.boundary);GIS.core.createSelectHandlers(q,q.layer.thematic1);GIS.core.createSelectHandlers(q,q.layer.thematic2);GIS.core.createSelectHandlers(q,q.layer.thematic3);GIS.core.createSelectHandlers(q,q.layer.thematic4);GIS.core.createSelectHandlers(q,q.layer.facility);q.map=r;q.viewport=i();q.olmap.mask=Ext.create("Ext.LoadMask",q.viewport.centerRegion.getEl(),{msg:"Loading"});GIS.core.MapLoader(q).load()}()};GIS.plugin.getMap=function(h){if(Ext.isString(h.url)&&h.url.split("").pop()==="/"){h.url=h.url.substr(0,h.url.length-1)}if(k){j(h)}else{f.push(h);if(!a){a=true;m(h.url)}}};DHIS=Ext.isObject(window.DHIS)?DHIS:{};DHIS.getMap=GIS.plugin.getMap})()});
